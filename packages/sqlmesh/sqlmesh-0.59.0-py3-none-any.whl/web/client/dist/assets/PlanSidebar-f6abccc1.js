import{r as j,D as Xe,a9 as Ye,I as Je,y as es,x as ue,F as ss,R as W,aa as as,ab as ns,ac as ts,X as Ge,ad as ls,Q as is,M as Fe,j as e,a4 as Pe,ae as Le,a as Y,a2 as y,k as F,af as w,ag as p,$ as I,o as _,a7 as xe,a5 as q,a1 as ne,ah as rs,d as v,c as C,ai as Ae,aj as J,e as Q,ak as ee,t as le,b as cs,al as Me,n as X,am as Be,L as Se,S as He,u as qe,a0 as os,an as ds,ao as us,ap as ms,E as Ie}from"./index-6baea4b4.js";import{B as G}from"./Banner-2c33a815.js";import{R as xs,p as hs}from"./ReportErrors-8bf7f666.js";import{v as A,M as be,P as ve}from"./disclosure-1f7e3e09.js";import{M as ps,H as fs,u as L,a as Re,b as R,E as P,P as E,C as ye,c as js}from"./PlanChangePreview-621a0413.js";import{I as $}from"./SearchList-014c5d81.js";import{s as gs}from"./popover-7a5b467a.js";import{T as bs,p as vs}from"./context-19a622d4.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./ModelLineage-4f4d45c4.js";import"./PlusIcon-bfa25c42.js";function ys({title:s,titleId:a,...n},t){return j.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:t,"aria-labelledby":a},n),s?j.createElement("title",{id:a},s):null,j.createElement("path",{fillRule:"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z",clipRule:"evenodd"}))}const ws=j.forwardRef(ys),ks=ws;let _e=j.createContext(null);_e.displayName="GroupContext";let Ns=j.Fragment;function Ps(s){var a;let[n,t]=j.useState(null),[l,r]=fs(),[m,c]=ls(),d=j.useMemo(()=>({switch:n,setSwitch:t,labelledby:l,describedby:m}),[n,t,l,m]),i={},h=s;return W.createElement(c,{name:"Switch.Description"},W.createElement(r,{name:"Switch.Label",props:{htmlFor:(a=d.switch)==null?void 0:a.id,onClick(x){n&&(x.currentTarget.tagName==="LABEL"&&x.preventDefault(),n.click(),n.focus({preventScroll:!0}))}}},W.createElement(_e.Provider,{value:d},Ge({ourProps:i,theirProps:h,defaultTag:Ns,name:"Switch.Group"}))))}let Ts="button";function Cs(s,a){let n=Je(),{id:t=`headlessui-switch-${n}`,checked:l,defaultChecked:r=!1,onChange:m,name:c,value:d,form:i,...h}=s,x=j.useContext(_e),u=j.useRef(null),o=es(u,a,x===null?null:x.setSwitch),[N,b]=bs(l,m,r),g=ue(()=>b==null?void 0:b(!N)),S=ue(T=>{if(is(T.currentTarget))return T.preventDefault();T.preventDefault(),g()}),M=ue(T=>{T.key===Fe.Space?(T.preventDefault(),g()):T.key===Fe.Enter&&vs(T.currentTarget)}),se=ue(T=>T.preventDefault()),K=j.useMemo(()=>({checked:N}),[N]),V={id:t,ref:o,role:"switch",type:gs(s,u),tabIndex:0,"aria-checked":N,"aria-labelledby":x==null?void 0:x.labelledby,"aria-describedby":x==null?void 0:x.describedby,onClick:S,onKeyUp:M,onKeyPress:se},B=ss();return j.useEffect(()=>{var T;let O=(T=u.current)==null?void 0:T.closest("form");O&&r!==void 0&&B.addEventListener(O,"reset",()=>{b(r)})},[u,b]),W.createElement(W.Fragment,null,c!=null&&N&&W.createElement(as,{features:ns.Hidden,...ts({as:"input",type:"checkbox",hidden:!0,readOnly:!0,form:i,checked:N,name:c,value:d})}),Ge({ourProps:V,theirProps:h,slot:K,defaultTag:Ts,name:"Switch"}))}let Ds=Xe(Cs),Ss=Ps,Te=Object.assign(Ds,{Group:Ss,Label:ps,Description:Ye});function Rs({show:s,children:a,afterLeave:n,onClose:t=()=>{}}){return e.jsx(Pe,{appear:!0,show:s,as:j.Fragment,afterLeave:n,children:e.jsxs(Le,{as:"div",className:"relative z-50 w-full h-full ",onClose:t,tabIndex:1,children:[e.jsx(Pe.Child,{as:j.Fragment,enter:"ease-out duration-300",enterFrom:"bg-overlay opacity-0",enterTo:"bg-overlay opacity-80",leave:"ease-in duration-200",leaveFrom:"bg-overlay opacity-80",leaveTo:"bg-overlay opacity-0",children:e.jsx("div",{className:"fixed inset-0"})}),e.jsx("div",{className:"w-full h-full fixed inset-0",children:e.jsx(Pe.Child,{as:j.Fragment,enter:"ease-out duration-300",enterFrom:"translate-x-[100%]",enterTo:"translate-x-0",leave:"ease-in duration-200",leaveFrom:"translate-x-0",leaveTo:"translate-x-[100%]",children:a})})]})})}function _s(){const s=Y(n=>n.environment),a=s.isInitial&&s.isDefault;return e.jsxs("div",{className:"flex flex-col pb-2 w-full",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h4",{className:"flex items-center text-xl px-6 font-bold whitespace-nowrap",children:[e.jsx("span",{children:"Target Environment is"}),e.jsx("span",{className:"block ml-2 px-2 py-1 font-sm rounded-md bg-primary-10 text-primary-500",children:s.name})]}),e.jsx("div",{className:"px-6",children:e.jsx(xs,{})})]}),e.jsx("div",{className:"w-full h-full overflow-auto scrollbar scrollbar--vertical px-4 py-2",children:a&&e.jsx(G,{variant:y.Warning,children:e.jsx(A,{defaultOpen:!1,children:({open:n})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(G.Headline,{className:"w-full mr-2 text-sm !mb-0",children:"Initializing Prod Environment"}),e.jsx(A.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:n?e.jsx(be,{className:"h-6 w-6 text-warning-500"}):e.jsx(ve,{className:"h-6 w-6 text-warning-500"})})]}),e.jsx(A.Panel,{className:"px-4 pb-2 text-sm mt-2",children:e.jsx(G.Description,{children:"Prod will be completely backfilled in order to ensure there are no data gaps. After this is applied, it is recommended to validate further changes in a dev environment before deploying to production."})})]})})})})]})}function Es(s=0){return j.useCallback(a=>{setTimeout(()=>{a==null||a.focus()},s)},[s])}function te(s,a=[],n="Start"){if(!a.includes(s))return n;let t;switch(s){case p.Done:t="Done";break;case p.Running:t="Running...";break;case p.Applying:t="Applying...";break;case p.Cancelling:t="Cancelling...";break;case p.Run:t="Run";break;case p.ApplyVirtual:t="Apply Virtual";break;case p.ApplyBackfill:t="Apply Backfill";break;default:t=n;break}return t}function Ke(s,a){const n=s.isFinished&&F(a.applyType)&&w(s.overview),t=n?s.start:a.start,l=n?s.end:a.end,r=n?s.overview.hasChanges:a.hasChanges,m=n?s.overview.hasBackfills:a.hasBackfills,c=n?s.changes:a.changes,d=n?s.backfills:a.backfills,i=n?s.validation:a.validation,h=n?s.plan_options:a.plan_options,x=n?s.overview.isVirtualUpdate:a.isVirtualUpdate,u=n?s.overview.isRunning:a.isRunning;return{start:t,end:l,hasChanges:r,hasBackfills:m,changes:c,backfills:d,validation:i,plan_options:h,isVirtualUpdate:x,isRunning:u}}function Fs({run:s,apply:a,cancel:n,reset:t,close:l,planAction:r,disabled:m=!1}){const{start:c,end:d,skip_tests:i,auto_apply:h,skip_backfill:x,no_gaps:u,no_auto_categorization:o,forward_only:N,restate_models:b,include_unmodified:g}=L(),S=Y(D=>D.environment),M=I(D=>D.planOverview),se=I(D=>D.planApply),K=I(D=>D.planCancel),V=Es(),B=r===p.Run,T=r===p.Done,O=r===p.Cancelling,oe=r===p.ApplyVirtual,ae=r===p.ApplyBackfill,U=r===p.Applying,Z=r===p.Running,de=Z||U||O;function we(D){D.stopPropagation(),l()}function ke(D){D.stopPropagation(),t()}function k(D){D.stopPropagation(),n()}function Qe(D){D.stopPropagation(),a()}function We(D){D.stopPropagation(),s()}const Ne=m||M.isRunning||se.isRunning||K.isCancelling;return e.jsxs("div",{children:[(B||Z||oe||ae||U)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-full flex px-4 py-2",children:e.jsxs("p",{className:"ml-2 text-xs",children:[e.jsx("span",{children:"Plan for"}),e.jsx("b",{className:"text-primary-500 font-bold mx-1",children:S.name}),e.jsx("span",{className:"inline-block mr-1",children:"environment"}),e.jsxs("span",{className:"inline-block mr-1",children:["from"," ",e.jsx("b",{children:_(xe(c))?c:"the begining of history"})]}),e.jsxs("span",{className:"inline-block mr-1",children:["till"," ",e.jsx("b",{children:_(xe(c))?d:"today"})]}),u&&e.jsxs("span",{className:"inline-block mr-1",children:["with ",e.jsx("b",{children:"No Gaps"})]}),x&&e.jsxs("span",{className:"inline-block mr-1",children:["without ",e.jsx("b",{children:"Backfills"})]}),N&&e.jsxs("span",{className:"inline-block mr-1",children:["consider as a ",e.jsx("b",{children:"Breaking Change"})]}),o&&e.jsxs("span",{className:"inline-block mr-1",children:["also set ",e.jsx("b",{children:"Change Category"})," manually"]}),_(xe(b))&&e.jsxs("span",{className:"inline-block mr-1",children:["and restate folowing models ",e.jsx("b",{children:b})]}),g&&e.jsx("span",{className:"inline-block mr-1",children:"with views for all models"})]})}),e.jsx(q,{})]}),e.jsxs("div",{className:"flex justify-between px-4 py-2",children:[e.jsxs("div",{className:"flex w-full items-center",children:[(B||Z)&&e.jsxs(ne,{disabled:Z||Ne,onClick:We,ref:V,variant:y.Primary,autoFocus:!0,children:[e.jsx("span",{children:te(r,[p.Running,p.Run])}),i&&e.jsx("span",{className:"inline-block ml-1",children:"And Skip Test"}),h&&e.jsx("span",{className:"inline-block ml-1",children:"And Auto Apply"})]}),(ae||oe||U)&&e.jsx(ne,{onClick:Qe,disabled:U||Ne,ref:V,variant:y.Primary,children:te(r,[p.Applying],ae?"Apply And Backfill":"Apply Virtual Update")}),de&&e.jsx(ne,{onClick:k,variant:y.Danger,className:"justify-self-end",disabled:O,children:te(r,[p.Cancelling],"Cancel")})]}),e.jsxs("div",{className:"flex items-center",children:[[de,m,B].every(_)&&e.jsx(ne,{onClick:ke,variant:y.Neutral,disabled:rs([p.Running,p.Applying,p.Cancelling],r)||Ne,children:te(r,[],"Start Over")}),e.jsx(ne,{onClick:we,variant:T?y.Primary:y.Neutral,disabled:m,ref:T||U?V:void 0,children:te(r,[p.Done],"Close")})]})]})]})}function As({label:s,enabled:a,setEnabled:n,a11yTitle:t,size:l=C.md,disabled:r=!1,className:m}){return e.jsxs(Te.Group,{as:"div",className:"flex items-center m-1",children:[e.jsxs(Te,{checked:r?!1:a,onChange:n,className:v("flex relative border-secondary-30 rounded-full m-0","shrink-0 focus:outline-none ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100 focus:border-secondary-500 focus-visible:ring-opacity-75","transition duration-200 ease-in-out",a?"bg-secondary-500":"bg-secondary-20",m,r?"opacity-50 cursor-not-allowed":"cursor-pointer",l===C.sm&&"h-[14px] w-6 focus:ring-1 border",l===C.md&&"h-5 w-10 focus:ring-2 border-2",l===C.lg&&"h-7 w-14 focus:ring-4 border-2"),disabled:r,children:[e.jsx("span",{className:"sr-only",children:t}),e.jsx("span",{"aria-hidden":"true",className:v("pointer-events-none inline-block transform rounded-full shadow-md transition duration-200 ease-in-out","bg-light",l===C.sm&&"h-3 w-3",l===C.md&&"h-4 w-4",l===C.lg&&"h-6 w-6",a&&l===C.sm&&"translate-x-[10px]",a&&l===C.md&&"translate-x-5",a&&l===C.lg&&"translate-x-7")})]}),s!=null&&e.jsx(Te.Label,{className:v("text-xs font-light ml-1 text-neutral-600 dark:text-neutral-400"),children:s})]})}function H({label:s,info:a,enabled:n,disabled:t=!1,setEnabled:l,className:r}){return e.jsxs("div",{className:v("flex justify-between",r),children:[e.jsxs("label",{className:"block mb-1 px-3 text-sm font-bold",children:[s,e.jsx("small",{className:"block text-xs text-neutral-500",children:a})]}),e.jsx(As,{disabled:t,enabled:n,setEnabled:l,size:C.lg})]})}function Ms({disabled:s=!1}){const a=Re(),{start:n,end:t,isInitialPlanRun:l}=L();return e.jsxs("div",{className:"flex w-full flex-wrap md:flex-nowrap",children:[e.jsx($,{className:"w-full md:w-[50%]",label:"Start Date (UTC)",info:"The start datetime of the interval",disabled:s||l,children:({disabled:r,className:m})=>e.jsx($.Textfield,{className:v(m,"w-full"),disabled:r,placeholder:"2023-12-13",value:n,onInput:c=>{c.stopPropagation(),a({type:R.DateStart,start:c.target.value})}})}),e.jsx($,{className:"w-full md:w-[50%]",label:"End Date (UTC)",info:"The end datetime of the interval",disabled:s||l,children:({disabled:r,className:m})=>e.jsx($.Textfield,{className:v(m,"w-full"),disabled:r,placeholder:"2022-12-13",value:t,onInput:c=>{c.stopPropagation(),a({type:R.DateEnd,end:c.target.value})}})})]})}function Bs({className:s}){const a=Re(),{skip_tests:n,no_gaps:t,skip_backfill:l,forward_only:r,auto_apply:m,no_auto_categorization:c,restate_models:d,isInitialPlanRun:i,create_from:h,include_unmodified:x}=L(),u=Y(b=>b.environment),o=Y(b=>b.environments),N=Ae.getOnlySynchronized(Array.from(o));return e.jsxs("form",{className:"w-full h-full",children:[e.jsxs("fieldset",{className:v("mb-10 mt-6"),children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1 px-4",children:"Set Dates"}),e.jsx("div",{className:"mt-3",children:e.jsx(Ms,{})})]}),e.jsx("fieldset",{className:v("mb-4 mt-6"),children:e.jsx(A,{children:({open:b})=>e.jsxs(e.Fragment,{children:[e.jsxs(A.Button,{className:"flex items-center w-full justify-between rounded-lg text-left text-sm px-4 pt-3 pb-2 bg-neutral-10 hover:bg-theme-darker dark:hover:bg-theme-lighter",children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1",children:"Additional Options"}),b?e.jsx(be,{className:"h-6 w-6 text-primary-500"}):e.jsx(ve,{className:"h-6 w-6 text-primary-500"})]}),e.jsxs(A.Panel,{className:"px-4 pb-2 text-sm text-neutral-500",children:[e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap",children:[_(u.isDefault)&&e.jsx($,{className:"w-full",label:"Create From Environment",info:"The environment to base the plan on rather than local files",disabled:N.length<2,children:({className:g,disabled:S})=>e.jsx($.Selector,{className:v(g,"w-full"),list:Ae.getOnlySynchronized(Array.from(o)).map(M=>({value:M.name,text:M.name})),onChange:M=>{a({type:R.PlanOptions,create_from:M})},value:h,disabled:S})}),e.jsx($,{className:"w-full",label:"Restate Models",info:`Restate data for specified models and models
                    downstream from the one specified. For production
                    environment, all related model versions will have
                    their intervals wiped, but only the current
                    versions will be backfilled. For development
                    environment, only the current model versions will
                    be affected`,children:({className:g})=>e.jsx($.Textfield,{className:v(g,"w-full"),placeholder:"project.model1, project.model2",disabled:i,value:d??"",onInput:S=>{S.stopPropagation(),a({type:R.PlanOptions,restate_models:S.target.value})}})})]})}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap w-full mt-3",children:[e.jsxs("div",{className:"w-full md:mr-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(H,{label:"Skip Tests",info:`Skip tests prior to generating the plan if they
              are defined`,enabled:!!n,setEnabled:g=>{a({type:R.PlanOptions,skip_tests:g})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(H,{label:"No Gaps",info:`Ensure that new snapshots have no data gaps when
              comparing to existing snapshots for matching
              models in the target environment`,enabled:!!t,disabled:i,setEnabled:g=>{a({type:R.PlanOptions,no_gaps:g})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(H,{label:"Skip Backfill",info:"Skip the backfill step",enabled:!!l,disabled:i,setEnabled:g=>{a({type:R.PlanOptions,skip_backfill:g})}})})]}),e.jsxs("div",{className:"w-full md:ml-2",children:[e.jsxs("div",{className:"block my-2",children:[e.jsx(H,{label:"Include Unmodified",info:"Indicates whether to create views for all models in the target development environment or only for modified ones",enabled:!!x,disabled:i,setEnabled:g=>{a({type:R.PlanOptions,include_unmodified:g})}}),e.jsx(H,{label:"Forward Only",info:"Create a plan for forward-only changes",enabled:!!r,disabled:i,setEnabled:g=>{a({type:R.PlanOptions,forward_only:g})}})]}),e.jsx("div",{className:"block my-2",children:e.jsx(H,{label:"Auto Apply",info:"Automatically apply the plan after it is generated",enabled:!!m,setEnabled:g=>{a({type:R.PlanOptions,auto_apply:g})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(H,{label:"No Auto Categorization",info:"Set category manually",enabled:!!c,disabled:i,setEnabled:g=>{a({type:R.PlanOptions,no_auto_categorization:g})}})})]})]})]})]})})})]})}function Is({environment:s,isInitialPlanRun:a}){const{start:n,end:t,skip_tests:l,no_gaps:r,skip_backfill:m,forward_only:c,no_auto_categorization:d,restate_models:i,create_from:h,include_unmodified:x}=L(),u=j.useMemo(()=>{if(!s.isDefault)return{start:n,end:a&&xe(i)?void 0:t}},[s,n,t,a,i]);return{planOptions:j.useMemo(()=>s.isDefaultInitial?{skip_tests:l,include_unmodified:!0}:{no_gaps:r,skip_backfill:m,forward_only:c,create_from:h,no_auto_categorization:d,skip_tests:l,restate_models:i,include_unmodified:x},[s,r,m,c,x,h,d,l,i]),planDates:u}}function Os({isInitialPlanRun:s}){const{start:a,end:n,skip_tests:t,no_gaps:l,skip_backfill:r,forward_only:m,include_unmodified:c,no_auto_categorization:d,restate_models:i,create_from:h,change_categorization:x}=L(),u=j.useMemo(()=>{if(!s)return{start:a,end:n}},[a,n,s]),o=j.useMemo(()=>Array.from(x.values()).reduce((N,{category:b,change:g})=>(N[g.model_name]=b.value,N),{}),[x]);return{planDates:u,planOptions:{no_gaps:l,skip_backfill:r,forward_only:m,include_unmodified:c,create_from:h,no_auto_categorization:d,skip_tests:t,restate_models:i},categories:o}}const Oe=3;function ie({progress:s=0,delay:a=0,duration:n=0,startFromZero:t=!0,className:l}){return _(t)&&(s=s<Oe?Oe:s),e.jsx("div",{className:v("w-full h-1 bg-neutral-30 overflow-hidden flex items-center rounded-lg my-1",l),children:e.jsx("div",{className:"transition-[width] h-full bg-success-500 rounded-lg",style:{width:`${s}%`,transitionDelay:`${a}ms`,transitionDuration:`${n}ms`}})})}const f=function({children:a,setRefTasksOverview:n,tasks:t}){const{models:l,taskCompleted:r,taskTotal:m,batchesTotal:c,batchesCompleted:d}=j.useMemo(()=>{const i=Object.entries(t),h=i.length;let x=0,u=0,o=0;return i.forEach(([N,{completed:b,total:g}])=>{x=b===g?x+1:x,u+=g,o+=b}),{models:i,taskCompleted:x,taskTotal:h,batchesTotal:u,batchesCompleted:o}},[t]);return e.jsx("div",{className:"text-prose",ref:n,children:a({models:l,completed:r,total:m,totalBatches:c,completedBatches:d})})};function zs({className:s,headline:a,environment:n,completed:t,total:l,updatedAt:r,updateType:m,completedBatches:c,totalBatches:d}){return e.jsx(Ee,{className:s,children:e.jsxs(he,{children:[e.jsxs(pe,{children:[e.jsx(fe,{children:e.jsx(Ze,{headline:a,environment:n})}),e.jsxs(je,{children:[e.jsx(re,{completed:t,total:l,unit:"task"}),e.jsx(ce,{}),e.jsx(re,{completed:c,total:d,unit:"batches"}),e.jsx(ce,{}),e.jsx(ge,{completed:c,total:d})]})]}),e.jsx(ie,{progress:J(c,d)}),r!=null&&e.jsx(Us,{updatedAt:r,updateType:m})]})})}function Vs({models:s,className:a,changes:n,showBatches:t=!0,showProgress:l=!0,showVirtualUpdate:r=!1,queue:m}){const{changesAdded:c,changesRemoved:d,changesModifiedDirect:i,changesModifiedIndirect:h}=j.useMemo(()=>{const u=n==null?void 0:n.modified;return{changesAdded:(n==null?void 0:n.added)??[],changesRemoved:(n==null?void 0:n.removed)??[],changesModifiedMetadata:(u==null?void 0:u.metadata)??[],changesModifiedIndirect:((u==null?void 0:u.indirect)??[]).map(({model_name:o})=>o),changesModifiedDirect:((u==null?void 0:u.direct)??[]).map(({model_name:o})=>o)}},[n]),x=j.useMemo(()=>F(m)?[]:s.filter(([u])=>m.includes(u)),[m,s]);return e.jsxs(e.Fragment,{children:[Q(m)&&e.jsxs("div",{className:"p-4 mt-6 shadow-lg bg-neutral-5 rounded-lg",children:[e.jsx(ee,{text:"Currently in proccess"}),e.jsx(De,{models:x,children:([u,o])=>e.jsxs(he,{children:[e.jsxs(pe,{children:[e.jsxs(fe,{children:[w(o.interval)&&e.jsx(ze,{start:o.interval[0],end:o.interval[1]}),e.jsx(Ue,{modelName:u,changeType:$e({modelName:u,changesAdded:c,changesRemoved:d,changesModifiedDirect:i,changesModifiedIndirect:h})})]}),e.jsxs(je,{children:[t&&e.jsx(re,{completed:o.completed,total:o.total,unit:"batch"}),e.jsx(ce,{}),l&&e.jsx(e.Fragment,{children:F(o.end)||F(o.start)?e.jsx(ge,{total:o.total,completed:o.completed}):e.jsx(Ve,{start:o.start,end:o.end})}),r&&e.jsx("span",{className:"inline-block whitespace-nowrap font-bold ml-2",children:"Updated"})]})]}),l?e.jsx(ie,{startFromZero:!1,progress:J(o.completed,o.total)}):e.jsx(q,{className:"my-1 border-neutral-200 opacity-50"})]})})]}),e.jsx(Ee,{className:a,children:e.jsx(De,{models:s,children:([u,o])=>e.jsxs(he,{children:[e.jsxs(pe,{children:[e.jsxs(fe,{children:[w(o.interval)&&e.jsx(ze,{start:o.interval[0],end:o.interval[1]}),e.jsx(Ue,{modelName:u,changeType:$e({modelName:u,changesAdded:c,changesRemoved:d,changesModifiedDirect:i,changesModifiedIndirect:h})})]}),e.jsxs(je,{children:[t&&e.jsx(re,{completed:o.completed,total:o.total,unit:"batch"}),e.jsx(ce,{}),l&&e.jsx(e.Fragment,{children:F(o.end)||F(o.start)?e.jsx(ge,{total:o.total,completed:o.completed}):e.jsx(Ve,{start:o.start,end:o.end})}),r&&e.jsx("span",{className:"inline-block whitespace-nowrap font-bold ml-2",children:"Updated"})]})]}),l?e.jsx(ie,{progress:J(o.completed,o.total),startFromZero:x.findIndex(([N])=>N===u)===-1}):e.jsx(q,{className:"my-1 border-neutral-200 opacity-50"})]})})})]})}function Ee({className:s,children:a}){return e.jsx("div",{className:v("my-3 max-h-[50vh] overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",s),children:a})}function he({className:s,children:a}){return e.jsx("div",{className:v("px-2",s),children:a})}function De({className:s,models:a,children:n}){return e.jsx("ul",{className:v("rounded-lg py-4 overflow-auto text-prose hover:scrollbar scrollbar--vertical scrollbar--horizontal",s),children:a.map(([t,l])=>e.jsx("li",{className:"mb-2",children:n([t,l])},t))})}function pe({className:s,children:a}){return e.jsx("div",{className:v("flex sm:justify-between sm:items-baseline text-xs",s),children:a})}function Ze({className:s,headline:a,environment:n}){return e.jsxs("span",{className:v("flex items-center",s),children:[e.jsx("span",{className:"block whitespace-nowrap text-sm font-medium",children:a}),w(n)&&e.jsx("small",{className:"inline-block ml-1 px-2 py-[0.125rem] text-xs font-bold bg-neutral-10 rounded-md",children:n})]})}function fe({className:s,children:a}){return e.jsx("div",{className:v("flex mr-6 w-full sm:w-auto overflow-hidden",s),children:a})}function je({className:s,children:a}){return e.jsx("div",{className:v("flex items-center",s),children:a})}function ze({className:s,start:a,end:n}){return e.jsxs("span",{className:v("inline-block mr-2 whitespace-nowrap font-mono",s),children:[a," – ",n]})}function re({className:s,total:a,completed:n,unit:t}){return e.jsxs("span",{className:v("inline-block whitespace-nowrap",s),children:[n," of ",a," ",hs(t,a)]})}function ce({className:s}){return e.jsx("span",{className:v("inline-block mx-2",s),children:"|"})}function ge({className:s,total:a,completed:n}){return e.jsxs("span",{className:v("inline-block whitespace-nowrap font-bold",s),children:[Math.ceil(J(n,a)),"%"]})}function Ve({className:s,start:a,end:n}){return e.jsx("span",{className:v("inline-block whitespace-nowrap font-bold",s),children:`${Math.floor((n-a)/6e4)}:${String(Math.ceil((n-a)/1e3%60)).padStart(2,"0")}`})}function Us({updateType:s,updatedAt:a}){return e.jsxs("div",{className:"flex justify-between mt-1",children:[e.jsxs("small",{className:"text-xs",children:[e.jsx("b",{children:"Update Type:"}),e.jsx("span",{className:"inline-block ml-1",children:s})]}),e.jsxs("small",{className:"text-xs",children:[e.jsx("b",{children:"Last Update:"}),e.jsx("span",{className:"inline-block ml-1",children:le(new Date(a),"yyyy-mm-dd hh-mm-ss",!1)})]})]})}function Ue({className:s,modelName:a,changeType:n}){return e.jsx("span",{className:v("font-bold whitespace-nowrap",n===P.Add&&"text-success-600  dark:text-success-500",n===P.Remove&&"text-danger-500",n===P.Direct&&"text-secondary-500 dark:text-primary-500",n===P.Indirect&&"text-warning-500",n===P.Default&&"text-prose",s),children:a})}f.Block=Ee;f.Summary=zs;f.Details=Vs;f.DetailsProgress=je;f.Task=he;f.Tasks=De;f.TaskDetails=pe;f.TaskProgress=ge;f.TaskSize=re;f.TaskDivider=ce;f.TaskInfo=fe;f.TaskHeadline=Ze;function $e({modelName:s,changesAdded:a,changesRemoved:n,changesModifiedDirect:t,changesModifiedIndirect:l}){return a.includes(s)?P.Add:n.includes(s)?P.Remove:t.includes(s)?P.Direct:l.includes(s)?P.Indirect:P.Default}function $s({report:s}){var a;return e.jsxs("div",{children:[e.jsxs("div",{className:"py-2",children:[e.jsxs("p",{children:["Total: ",s.total]}),e.jsxs("p",{children:["Succeeded: ",s.successful]}),e.jsxs("p",{children:["Failed: ",s.failures]}),e.jsxs("p",{children:["Errors: ",s.errors]}),e.jsxs("p",{children:["Dialect: ",s.dialect]})]}),e.jsx("ul",{children:(a=s.details)==null?void 0:a.map(n=>e.jsxs("li",{className:"flex mb-1",children:[e.jsx("span",{className:"inline-block mr-4",children:"—"}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("span",{className:"inline-block mb-2",children:n.message}),e.jsx("code",{className:"inline-block max-h-[50vh] bg-theme py-2 px-4 rounded-lg w-full overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",children:e.jsx("pre",{children:n.details})})]})]},n.message))})]})}function Gs(){var b,g;const s=cs(S=>S.tests),a=I(S=>S.planApply),n=I(S=>S.planOverview),{start:t,end:l,hasChanges:r,hasBackfills:m,changes:c,backfills:d,validation:i,plan_options:h,isVirtualUpdate:x}=Ke(a,n),u=w(s)&&!!s.total,o=w(s)&&!!s.message,N=w(s)&&!!s.failures;return e.jsxs("div",{className:"py-4",children:[w(t)&&w(l)&&e.jsxs("div",{className:"flex justify-between items-center mb-4 whitespace-nowrap",children:[e.jsxs("small",{className:"text-neutral-500 block px-4",children:["Start Date: ",e.jsx("b",{children:le(new Date(t))})]}),e.jsx(q,{}),e.jsxs("small",{className:"text-neutral-500 block px-4",children:["End Date: ",e.jsx("b",{children:le(new Date(l))})]})]}),Me(r)||F(c)?e.jsx(me,{variant:y.Info,className:"mt-2",children:"No Changes"}):e.jsx(Ls,{report:c,isOpen:!0}),Me(m)||F(d)?e.jsx(me,{variant:y.Info,className:"mt-2",children:"No Backfills"}):e.jsx(Hs,{report:d}),X(h==null?void 0:h.skip_tests)&&e.jsx(me,{variant:y.Info,className:"mt-2",children:"Tests Skipped"}),o&&e.jsx(qs,{report:s}),u&&e.jsx(Ks,{report:s}),w(i)&&e.jsx(Zs,{report:i}),X(x)&&e.jsx(sa,{isUpdated:X((g=(b=a.promote)==null?void 0:b.meta)==null?void 0:g.done)}),N||a.shouldShowEvaluation&&e.jsxs(Qs,{start:a.evaluationStart,end:a.evaluationEnd,children:[w(a.creation)&&e.jsx(Ws,{report:a.creation}),w(a.restate)?e.jsx(Xs,{report:a.restate}):e.jsx(me,{variant:y.Info,className:"mt-2",children:"No Models To Restate"}),w(a.backfill)&&w(a.environment)&&e.jsx(Ys,{backfill:a.backfill,backfills:d,isVirtualUpdate:x,environment:a.environment}),w(a.promote)&&e.jsx(Js,{report:a.promote})]})]})}function Ls({report:s,isOpen:a=!1}){return e.jsx(z,{meta:s.meta,states:["Changes Collected","Failed Getting Plan Changes","Getting Plan Changes..."],isOpen:a,panel:e.jsx(ea,{})})}function Hs({report:s,isOpen:a=!1}){var n,t;return e.jsx(z,{meta:s.meta,states:["Backfills Collected","Failed Getting Plan Backfills","Getting Plan Backfills..."],isOpen:a,panel:e.jsx(E,{headline:`Models ${((n=s.models)==null?void 0:n.length)??0}`,type:P.Default,children:e.jsx(E.Default,{type:P.Default,changes:((t=s==null?void 0:s.models)==null?void 0:t.map(({model_name:l})=>l))??[]})})})}function qs({report:s}){return e.jsx(z,{meta:{status:"success",...s},trigger:e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-6 mr-4"}),e.jsx(ee,{text:"Tests Completed",size:C.sm,variant:y.Success,className:"w-full"})]}),children:e.jsx("p",{className:"mb-0.5",children:s.message})})}function Ks({report:s}){return e.jsx(z,{variant:y.Danger,meta:{status:"fail",...s},trigger:e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-6 mr-4"}),e.jsx(ee,{text:"Tests Failed",size:C.sm,variant:y.Danger,className:"w-full"})]}),children:e.jsx($s,{report:s})})}function Zs({report:s}){return e.jsx(z,{meta:s.meta,states:["Plan Validated","Plan Validation Failed","Validating Plan..."],showDetails:!1})}function Qs({start:s,end:a,children:n}){const t=j.useRef(null);return j.useEffect(()=>{requestAnimationFrame(()=>{var l;(l=t.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})})},[]),e.jsxs("div",{ref:t,className:"pt-6 pb-2",children:[w(s)&&e.jsxs(e.Fragment,{children:[e.jsxs("small",{className:"text-neutral-500 block px-4 mb-1",children:["Evaluation started at"," ",e.jsx("b",{children:le(new Date(s),"yyyy-mm-dd hh-mm-ss")})]}),e.jsx(q,{}),e.jsx("small",{className:"text-neutral-500 block px-4 mt-1",children:"Given a plan, it pushes snapshots into the state and then kicks off the backfill process for all affected snapshots. Once backfill is done, snapshots that are part of the plan are promoted in the environment targeted by this plan."})]}),e.jsx("div",{className:"py-2",children:n}),w(a)&&e.jsxs(e.Fragment,{children:[e.jsx(q,{}),e.jsxs("small",{className:"text-neutral-500 block px-4 mt-1",children:["Evaluation stopped at"," ",e.jsx("b",{children:le(new Date(a),"yyyy-mm-dd hh-mm-ss")})]})]})]})}function Ws({report:s,isOpen:a}){return e.jsx(z,{meta:s.meta,states:["Snapshot Tables Created","Snapshot Tables Creation Failed","Creating Snapshot Tables..."],isOpen:a,children:w(s.total_tasks)&&e.jsx(f.Block,{children:e.jsxs(f.Task,{children:[e.jsxs(f.TaskDetails,{children:[e.jsx(f.TaskInfo,{children:e.jsx(f.TaskHeadline,{headline:"Snapshot Tables"})}),e.jsxs(f.DetailsProgress,{children:[e.jsx(f.TaskSize,{completed:s.total_tasks,total:s.num_tasks,unit:"task"}),e.jsx(f.TaskDivider,{}),e.jsx(f.TaskProgress,{completed:s.num_tasks,total:s.total_tasks})]})]}),e.jsx(ie,{progress:J(s.num_tasks,s.total_tasks)})]})})})}function Xs({report:s}){return e.jsx(z,{meta:s.meta,states:["Restate Models","Restate Models Failed","Restating Models..."]})}function Ys({environment:s,backfill:a,isVirtualUpdate:n,backfills:t}){const{change_categorization:l}=L(),r=j.useMemo(()=>Array.from(l.values()).reduce((c,{category:d,change:i})=>{var h;return(h=i==null?void 0:i.indirect)==null||h.forEach(x=>{var u;F(c[x])&&(c[x]=[]),(u=c[x])==null||u.push(d.value!==Be.NUMBER_1)}),d.value===Be.NUMBER_3&&(c[i.model_name]=[!0]),c},{}),[l]),m=j.useMemo(()=>{var c;return((c=t==null?void 0:t.models)==null?void 0:c.reduce((d,i)=>{var b;const h=i.model_name??i.view_name,x=i.interval,u={completed:0,total:i.batches,interval:x,view_name:i.view_name,...(b=a==null?void 0:a.tasks)==null?void 0:b[h]},o=r[h];return(F(o)?!1:o.every(Boolean))||(d[h]=u),d},{}))??{}},[a,t,l]);return e.jsx(z,{meta:a.meta,states:["Intervals Backfilled","Intervals Backfilling Failed","Backfilling Intervals..."],showDetails:!0,isOpen:!0,children:e.jsx(f,{tasks:m,children:({total:c,completed:d,models:i,completedBatches:h,totalBatches:x})=>e.jsxs(e.Fragment,{children:[e.jsx(f.Summary,{environment:s,headline:"Target Environment",completed:d,total:c,completedBatches:h,totalBatches:x,updateType:n?"Virtual":"Backfill"}),w(i)&&e.jsx(f.Details,{models:i,queue:a.queue,showBatches:!0,showVirtualUpdate:n,showProgress:!0})]})})})}function Js({report:s}){const a=j.useRef(null);return j.useEffect(()=>{requestAnimationFrame(()=>{var n;(n=a.current)==null||n.scrollIntoView({behavior:"smooth",block:"start"})})},[]),e.jsx("div",{ref:a,children:e.jsx(z,{meta:s.meta,states:["Environment Promoted","Promotion Failed","Promoting Environment..."],children:e.jsx(f.Block,{children:e.jsxs(f.Task,{children:[e.jsxs(f.TaskDetails,{children:[e.jsx(f.TaskInfo,{children:e.jsx(f.TaskHeadline,{headline:`Promote Environment: ${s.target_environment}`})}),e.jsxs(f.DetailsProgress,{children:[e.jsx(f.TaskSize,{completed:s.total_tasks,total:s.num_tasks,unit:"task"}),e.jsx(f.TaskDivider,{}),e.jsx(f.TaskProgress,{completed:s.num_tasks,total:s.total_tasks})]})]}),e.jsx(ie,{progress:J(s.num_tasks,s.total_tasks)})]})})})})}function ea(){const s=I(h=>h.planOverview),a=I(h=>h.planApply),{hasChanges:n,changes:t,isVirtualUpdate:l,isRunning:r}=Ke(a,s),m=_(n)&&_(r)&&_(l)||r,{added:c=[],removed:d=[],modified:i={}}=t??{};return e.jsxs("div",{className:v("w-full my-2",m&&"h-[25vh]"),children:[r&&e.jsx(G,{isFull:!0,isCenter:!0,children:e.jsx(Se,{text:"Checking Models...",hasSpinner:!0,size:C.lg})}),_(n)&&_(r)&&e.jsx(G,{isFull:_(l),isCenter:_(l),children:e.jsx(ee,{size:l?C.md:C.lg,text:"No Changes"})}),X(n)&&_(r)&&e.jsxs(e.Fragment,{children:[Q(c)&&e.jsx(E,{className:"w-full my-2",headline:"Added Models",type:P.Add,children:e.jsx(E.Default,{type:P.Add,changes:c})}),Q(d)&&e.jsx(E,{className:"w-full my-2",headline:"Removed Models",type:P.Remove,children:e.jsx(E.Default,{type:P.Remove,changes:d})}),Q(i==null?void 0:i.direct)&&e.jsx(E,{className:"my-2 w-full",headline:"Modified Directly",type:P.Direct,children:e.jsx(E.Direct,{changes:i.direct??[]})}),Q(i==null?void 0:i.indirect)&&e.jsx(E,{className:"my-2 w-full",headline:"Modified Indirectly",type:P.Indirect,children:e.jsx(E.Indirect,{changes:i.indirect??[]})}),Q(i==null?void 0:i.metadata)&&e.jsx(E,{className:"my-2 w-full",headline:"Modified Metadata",type:P.Default,children:e.jsx(E.Default,{type:P.Default,changes:(i==null?void 0:i.metadata)??[]})})]})]})}function sa({isUpdated:s=!1}){const{virtualUpdateDescription:a}=L();return e.jsx(A,{children:({open:n})=>e.jsxs(e.Fragment,{children:[e.jsxs(G,{className:"my-2 flex items-center",variant:s?y.Success:y.Info,children:[e.jsxs(e.Fragment,{children:[s&&e.jsx(ye,{className:"w-6 mr-4"}),e.jsx(ee,{className:"w-full",text:s?"Virtual Update Completed":"Virtual Update",size:C.sm,variant:s?y.Success:y.Info})]}),e.jsx("div",{className:"flex items-center",children:e.jsx(A.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:n?e.jsx(be,{className:"w-5"}):e.jsx(ve,{className:"w-5"})})})]}),e.jsx(A.Panel,{className:"px-2 text-xs",children:e.jsx("div",{className:"p-4 rounded-md bg-neutral-5",children:a})})]})})}function me({hasSpinner:s=!1,variant:a=y.Primary,index:n,children:t,className:l}){return e.jsx(G,{className:l,variant:a,children:e.jsxs("span",{className:"flex items-center w-full",children:[w(n)&&e.jsxs("span",{className:"inline-block mr-3 font-black whitespace-nowrap",children:["Stage ",n,":"]}),s&&e.jsx(He,{className:"w-4 h-4 mr-2"}),t]})})}function z({meta:s,states:a=["Success","Failed","Running"],isOpen:n=!1,trigger:t,panel:l,children:r,showDetails:m=!0}){const c=s.status==="success"?y.Success:s.status==="fail"?y.Danger:y.Info,[d,i,h]=a,x=s.status==="success"?d:s.status==="fail"?i:h;return e.jsx(A,{defaultOpen:n,children:({open:u})=>e.jsxs(e.Fragment,{children:[e.jsxs(G,{className:"my-2 flex items-center",variant:c,children:[F(t)?e.jsxs(e.Fragment,{children:[s.status==="success"&&e.jsx(ye,{className:"w-6 mr-4"}),s.status==="fail"&&e.jsx(ks,{className:"w-6 mr-4"}),s.status==="init"?e.jsx(Se,{text:x,hasSpinner:!0,size:C.sm,variant:y.Primary,className:"w-full"}):e.jsxs("span",{className:"flex w-full items-baseline",children:[e.jsx(ee,{text:x,size:C.sm,variant:c}),w(s.duration)&&e.jsxs("p",{className:"text-xs text-neutral-400 inline-block ml-2",children:["in ",e.jsx("b",{children:s.duration/1e3})," seconds"]})]})]}):t,m&&e.jsx("div",{className:"flex items-center",children:e.jsx(A.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:u?e.jsx(be,{className:"w-5"}):e.jsx(ve,{className:"w-5"})})})]}),e.jsxs(A.Panel,{className:"px-2 text-xs",children:[w(r)&&e.jsx("div",{className:v("p-4 rounded-md",c===y.Danger?"bg-danger-10 text-danger-500":"bg-neutral-5"),children:r}),s.status!=="fail"&&l]})]})})}const Ce=ms.shouldDisplay;function aa({environment:s,disabled:a,onClose:n}){const t=Re(),{removeError:l}=qe(),{auto_apply:r}=L(),m=Y(k=>k.isRunningPlan),c=I(k=>k.planOverview),d=I(k=>k.planApply),i=I(k=>k.planCancel),h=F(s==null?void 0:s.isDefault)||X(s==null?void 0:s.isDefault),x=Is({environment:s,isInitialPlanRun:h}),u=Os({isInitialPlanRun:h}),{refetch:o,cancel:N,isFetching:b}=os(s.name,x),{refetch:g,cancel:S,isFetching:M}=ds(s.name,u),{refetch:se,isFetching:K}=us(),[V,B]=j.useState(p.Run);j.useEffect(()=>{if(w(c.environment)&&c.environment!==s.name)B(p.Run),O();else{const k=ta({planOverviewTracker:c,planApplyTracker:d,planCancelTracker:i,isFetchingPlanCancel:K,isFetchingPlanRun:b,isFetchingPlanApply:M,isRunning:m});B(k)}},[c,d,i,m,K,b,M,s]);function T(){t([{type:R.ResetPlanOptions}])}function O(){c.reset(),d.reset(),T(),B(p.Run)}function oe(){l(Ie.RunPlan),l(Ie.ApplyPlan),T(),n()}function ae(){t([{type:R.ResetTestsReport}]),B(p.Cancelling);let k;V===p.Applying?k=N:k=S,k(),se().then(()=>{B(p.Run)}).catch(()=>{O()})}function U(){t([{type:R.ResetTestsReport}]),g().catch(console.log)}function Z(){d.reset(),t([{type:R.ResetTestsReport}]),o().then(({data:k})=>{t([{type:R.Dates,start:k==null?void 0:k.start,end:k==null?void 0:k.end}]),r&&U()})}const de=Ce(d,s),we=Ce(c,s),ke=Ce(i,s);return e.jsxs("div",{className:"flex flex-col w-full h-full overflow-hidden",children:[e.jsx(_s,{}),e.jsx("div",{className:"w-full h-full px-4 overflow-y-scroll hover:scrollbar scrollbar--vertical",children:ke?e.jsx(na,{}):de||we?e.jsx(Gs,{}):e.jsx(Bs,{className:"w-full"})}),e.jsx(q,{}),e.jsx(Fs,{planAction:V,apply:U,run:Z,cancel:ae,close:oe,reset:O,disabled:a})]})}function na(){return e.jsx("div",{className:"w-full h-full p-4",children:e.jsx("div",{className:"w-full h-full flex justify-center items-center p-4 bg-warning-10 rounded-lg overflow-hidden",children:e.jsxs(Se,{className:"inline-block",children:[e.jsx(He,{variant:y.Warning,className:"w-3 h-3 border border-neutral-10 mr-4"}),e.jsx("h3",{className:"text-2xl text-warning-500 font-bold",children:"Cancelling Plan..."})]})})})}function ta({isRunning:s,planOverviewTracker:a,planApplyTracker:n,planCancelTracker:t,isFetchingPlanCancel:l,isFetchingPlanRun:r,isFetchingPlanApply:m}){const c=s&&a.isRunning,d=s&&n.isRunning,i=s&&t.isRunning,{isLatest:h,isVirtualUpdate:x,isBackfillUpdate:u}=a,o=n.isFinished||h;return i||l?p.Cancelling:d||m?p.Applying:c||r?p.Running:x?p.ApplyVirtual:u?p.ApplyBackfill:o?p.Done:p.Run}const fa=j.memo(function(){const{isPlanOpen:a,setIsPlanOpen:n}=qe(),t=Y(d=>d.environment),[l,r]=j.useState(!1);function m(){r(!0)}const c=X(a)&&_(l);return e.jsx(Rs,{show:c,afterLeave:()=>{r(!1),n(!1)},children:e.jsx(Le.Panel,{className:"bg-theme border-8 border-r-0 border-secondary-10 dark:border-primary-10 absolute w-[90%] md:w-[75%] xl:w-[60%] h-full right-0 flex flex-col",children:e.jsx(js,{children:e.jsx(aa,{disabled:l,onClose:m,environment:t},t.name)})})})});export{fa as default};
