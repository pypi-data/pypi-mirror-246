# yaml-language-server: $schema=../schemas/ibek.support.schema.json

################################################################################
### ibek support YAML to demonstrate the use of object references
################################################################################
module: object_module

defs:
  - name: RefObject
    description: |
      Example object for reference from Consumer
    args:
      - type: id
        name: name
        description: Port name

      - type: str
        name: IP
        description: IP address of port
        default: 127.0.0.1

    values:
      - name: test_value
        value: "{{ name }}.{{ IP }}"
        description: test jinja render of arg values

    env_vars:
      - name: REF_OBJECT_NAME
        value: "{{ name }}"

    pre_init:
      - when: first
        value: |
          # This line should appear once only in the pre_init section
      - value: |
          # TestValues testValue
          TestValues {{ test_value }}

    pvi:
      yaml_path: simple.pvi.device.yaml
      prefix: "{{ name }}"

  - name: Consumer
    description: |
      A class that uses RefObject
    args:
      - type: id
        name: name
        description: Consumer name

      - type: object
        name: PORT
        description: a reference to an RefObject

  - name: ConsumerTwo
    description: |
      Another class that uses RefObject
    args:
      - type: id
        name: name
        description: Consumer name

      - type: object
        name: PORT
        description: a reference to an RefObject

    pre_init:
      - value: |
          # ExampleTestFunction asynPortIP name port value
          ExampleTestFunction {{ PORT.IP }} {{ name }} {{ PORT }} {{ PORT.test_value }}
          # PORT defaults to the id of PORT, i.e. PORT.name

    databases:
      - file: test.db
        args:
          name:
          ip: "{{ PORT.IP }}"
          value: "{{ PORT.test_value }}"
