/*
 * recorderworker.min.js  version 7.2
 *
 * Sweet Home 3D, Copyright (c) 2022 Emmanuel PUYBARET / eTeks <info@eteks.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
function URLContent(a){this.url=a}URLContent.__class="com.eteks.sweethome3d.tools.URLContent";URLContent.__interfaces=["com.eteks.sweethome3d.model.Content"];URLContent.urlContents={};URLContent.fromURL=function(b){var a=URLContent.urlContents[b];if(a==null){if(b.indexOf(LocalStorageURLContent.LOCAL_STORAGE_PREFIX)===0){a=new LocalStorageURLContent(b)}else{if(b.indexOf(IndexedDBURLContent.INDEXED_DB_PREFIX)===0){a=new IndexedDBURLContent(b)}else{a=new URLContent(b)}}URLContent.urlContents[b]=a}return a};URLContent.prototype.getURL=function(){if(typeof document!=="undefined"){var n=this.url.indexOf("https://");var i=this.url.indexOf("http://");if(n!==-1||i!==-1){var e=document.getElementsByTagName("script");if(e&&e.length>0){var c=document.getElementsByTagName("script")[0].src;var h=c.indexOf("://");var g=c.substring(0,h);var a=n!==-1?"https":"http";if(g!=a){var j=c.substring(h+"://".length,c.indexOf("/",h+"://".length));var f="";var k=j.indexOf(":");if(k>0){f=j.substring(k);j=j.substring(0,k)}var m=n!==-1?n:i;var l=this.url.indexOf("://",m);var b=this.url.indexOf("/",l+"://".length);var d=this.url.substring(l+"://".length,b);if(d.indexOf(":")>0){d=d.substring(0,d.indexOf(":"))}if(j==d){return this.url.substring(0,m)+g+"://"+j+f+this.url.substring(b)}}}}}return this.url};URLContent.prototype.getStreamURL=function(a){a.urlReady(this.getURL())};URLContent.prototype.isStreamURLReady=function(){return true};URLContent.prototype.isJAREntry=function(){return this.url.indexOf("jar:")===0&&this.url.indexOf("!/")!==-1};URLContent.prototype.getJAREntryURL=function(){if(!this.isJAREntry()){throw new IllegalStateException("Content isn't a JAR entry")}var a=this.getURL();return a.substring("jar:".length,a.indexOf("!/"))};URLContent.prototype.getJAREntryName=function(){if(!this.isJAREntry()){throw new IllegalStateException("Content isn't a JAR entry")}return this.url.substring(this.url.indexOf("!/")+2)};URLContent.prototype.equals=function(a){if(a===this){return true}else{if(a instanceof URLContent){return a.url==this.url}else{return false}}};URLContent.prototype.hashCode=function(){return this.url.split("").reduce(function(d,c){d=((d<<5)-d)+c.charCodeAt(0);return d&d},0)};function HomeURLContent(a){URLContent.call(this,a)}HomeURLContent.prototype=Object.create(URLContent.prototype);HomeURLContent.prototype.constructor=HomeURLContent;HomeURLContent.__class="com.eteks.sweethome3d.io.HomeURLContent";HomeURLContent.__interfaces=["com.eteks.sweethome3d.model.Content"];function SimpleURLContent(a){URLContent.call(this,a)}SimpleURLContent.prototype=Object.create(URLContent.prototype);SimpleURLContent.prototype.constructor=SimpleURLContent;SimpleURLContent.__class="com.eteks.sweethome3d.tools.SimpleURLContent";SimpleURLContent.__interfaces=["com.eteks.sweethome3d.model.Content"];function LocalURLContent(a){URLContent.call(this,a);this.savedContent=null}LocalURLContent.prototype=Object.create(URLContent.prototype);LocalURLContent.prototype.constructor=LocalURLContent;LocalURLContent.prototype.getSavedContent=function(){return this.savedContent};LocalURLContent.prototype.setSavedContent=function(a){this.savedContent=a};LocalURLContent.prototype.getStreamURL=function(a){throw new UnsupportedOperationException("LocalURLContent abstract class")};LocalURLContent.prototype.getBlob=function(a){throw new UnsupportedOperationException("LocalURLContent abstract class")};LocalURLContent.prototype.writeBlob=function(c,e,a){var d=this;var b=[];this.getBlob({blobReady:function(g){var B;if(Array.isArray(e)){var E=e[0];B=new Array(e.length);for(var y=0;y<e.length;y++){B[y]=encodeURIComponent(e[y])}e=E}else{B=encodeURIComponent(e)}var n=CoreTools.format(c.replace(/(%[^s^\d])/g,"%$1"),B);if(n.indexOf(LocalStorageURLContent.LOCAL_STORAGE_PREFIX)===0){var t=n.substring(n.indexOf(LocalStorageURLContent.LOCAL_STORAGE_PREFIX)+LocalStorageURLContent.LOCAL_STORAGE_PREFIX.length);var u=decodeURIComponent(t.indexOf("?")>0?t.substring(0,t.indexOf("?")):t);return LocalURLContent.convertBlobToBase64(g,function(G){try{localStorage.setItem(u,G);a.blobSaved(d,e)}catch(i){if(a.blobError!==undefined){a.blobError(i,i.message)}}})}else{if(n.indexOf(IndexedDBURLContent.INDEXED_DB_PREFIX)===0){var D=n.indexOf(IndexedDBURLContent.INDEXED_DB_PREFIX)+IndexedDBURLContent.INDEXED_DB_PREFIX.length;var q=n.indexOf("/",D);var A=n.indexOf("?",q+1);var C=n.substring(D,q);var l=n.substring(q+1,A);var v=n.substring(A+1).split("&");var F=null;var r=null;var f=null;var p=null;for(var y=0;y<v.length;y++){var j=v[y].indexOf("=");var m=v[y].substring(0,j);var w=v[y].substring(j+1);switch(m){case"keyPathField":r=w;break;case"contentField":f=w;break;case"dateField":p=w;break}}var s={};for(var y=0;y<v.length;y++){var j=v[y].indexOf("=");var m=v[y].substring(0,j);var w=v[y].substring(j+1);if(r===m){F=decodeURIComponent(w)}else{if(m.indexOf("Field",m.length-"Field".length)===-1){s[m]=decodeURIComponent(w)}}}var x=function(i){var G=i.target.result;if(!G.objectStoreNames.contains(l)){G.createObjectStore(l,{keyPath:r})}};var z=function(i){if(a.blobError!==undefined){a.blobError(i.target.errorCode,"Can't connect to database "+C)}};var h=function(M){var O=M.target.result;try{if(!O.objectStoreNames.contains(l)){O.close();var J=indexedDB.open(C,O.version+1);J.addEventListener("upgradeneeded",x);J.addEventListener("error",z);J.addEventListener("success",h)}else{var G=O.transaction(l,"readwrite");var N=G.objectStore(l);var I={};I[r]=F;I[f]=g;if(p!=null){I[p]=Date.now()}for(var H in s){I[H]=s[H]}var L=N.put(I);L.addEventListener("error",function(i){if(a.blobError!==undefined){a.blobError(i.target.errorCode,"Can't store item in "+l)}});L.addEventListener("success",function(i){a.blobSaved(d,e)});G.addEventListener("complete",function(i){O.close()});b.push(G)}}catch(K){if(a.blobError!==undefined){a.blobError(K,K.message)}}};if(indexedDB!=null){var k=indexedDB.open(C);k.addEventListener("upgradeneeded",x);k.addEventListener("error",z);k.addEventListener("success",h)}else{a.blobError(new Error("indexedDB"),"indexedDB unavailable")}}else{var k=new XMLHttpRequest();k.open("POST",n,true);k.addEventListener("load",function(i){if(k.readyState===XMLHttpRequest.DONE){if(k.status===200){a.blobSaved(d,e)}else{if(a.blobError!==undefined){a.blobError(k.status,k.responseText)}}}});var o=function(i){if(a.blobError!==undefined){a.blobError(0,"Can't post "+n)}};k.addEventListener("error",o);k.addEventListener("timeout",o);k.send(g);b.push(k)}}},blobError:function(f,g){if(a.blobError!==undefined){a.blobError(f,g)}}});return{abort:function(){for(var f=0;f<b.length;f++){b[f].abort()}}}};LocalURLContent.convertBlobToBase64=function(c,b){var a=new FileReader();a.onload=function(){b(a.result)};a.readAsDataURL(c);return a};function BlobURLContent(a){LocalURLContent.call(this,URL.createObjectURL(a));this.blob=a}BlobURLContent.prototype=Object.create(LocalURLContent.prototype);BlobURLContent.prototype.constructor=BlobURLContent;BlobURLContent.__class="com.eteks.sweethome3d.tools.BlobURLContent";BlobURLContent.__interfaces=["com.eteks.sweethome3d.model.Content"];BlobURLContent.BLOB_PREFIX="blob:";BlobURLContent.fromBlob=function(a){for(var b in URLContent.urlContents){if(URLContent.urlContents[b] instanceof BlobURLContent&&URLContent.urlContents[b].blob===a){return URLContent.urlContents[b]}}var c=new BlobURLContent(a);URLContent.urlContents[c.getURL()]=c;return c};BlobURLContent.fromImage=function(e,d,a){var b=document.createElement("canvas");var c=b.getContext("2d");b.width=e.width;b.height=e.height;c.drawImage(e,0,0,e.width,e.height);if(b.msToBlob){a(BlobURLContent.fromBlob(b.msToBlob()))}else{b.toBlob(function(f){a(BlobURLContent.fromBlob(f))},d,0.7)}};BlobURLContent.prototype.getStreamURL=function(a){a.urlReady(this.getURL())};BlobURLContent.prototype.getBlob=function(a){if(a!==undefined){a.blobReady(this.blob)}return this.blob};function LocalStorageURLContent(a){LocalURLContent.call(this,a);this.blob=null;this.blobUrl=null}LocalStorageURLContent.prototype=Object.create(LocalURLContent.prototype);LocalStorageURLContent.prototype.constructor=LocalStorageURLContent;LocalStorageURLContent.__class="com.eteks.sweethome3d.tools.LocalStorageURLContent";LocalStorageURLContent.__interfaces=["com.eteks.sweethome3d.model.Content"];LocalStorageURLContent.LOCAL_STORAGE_PREFIX="localstorage://";LocalStorageURLContent.prototype.getStreamURL=function(a){if(this.blobUrl==null){var b=this;this.getBlob({blobReady:function(c){a.urlReady(b.blobUrl)},blobError:function(c,d){if(a.urlError!==undefined){a.urlError(c,d)}}})}else{a.urlReady(this.blobUrl)}};LocalStorageURLContent.prototype.getBlob=function(e){if(this.blob==null){var b=this.getURL();if(b.indexOf(LocalStorageURLContent.LOCAL_STORAGE_PREFIX)===0){var k=b.substring(b.indexOf(LocalStorageURLContent.LOCAL_STORAGE_PREFIX)+LocalStorageURLContent.LOCAL_STORAGE_PREFIX.length);var h=decodeURIComponent(k.indexOf("?")>0?k.substring(0,k.indexOf("?")):k);var d=localStorage.getItem(h);if(d!=null){var g=d.substring("data:".length,d.indexOf(";"));var f=atob(d.substring(d.indexOf(",")+1));var j=new Array(f.length);for(var c=0;c<j.length;c++){j[c]=f.charCodeAt(c)}var a=new Uint8Array(j);this.blob=new Blob([a],{type:g});this.blobUrl=URL.createObjectURL(this.blob)}else{if(e.urlError!==undefined){e.urlError(1,"No key '"+h+"' in localStorage")}}}else{if(e.urlError!==undefined){e.urlError(1,b+" not a local storage url")}}}if(e!==undefined&&e.blobReady!==undefined&&this.blob!=null){e.blobReady(this.blob)}return this.blob};function IndexedDBURLContent(a){LocalURLContent.call(this,a);this.blob=null;this.blobUrl=null}IndexedDBURLContent.prototype=Object.create(LocalURLContent.prototype);IndexedDBURLContent.prototype.constructor=IndexedDBURLContent;IndexedDBURLContent.__class="com.eteks.sweethome3d.tools.IndexedDBURLContent";IndexedDBURLContent.__interfaces=["com.eteks.sweethome3d.model.Content"];IndexedDBURLContent.INDEXED_DB_PREFIX="indexeddb://";IndexedDBURLContent.prototype.getStreamURL=function(a){if(this.blobUrl==null){var b=this;this.getBlob({blobReady:function(c){a.urlReady(b.blobUrl)},blobError:function(c,d){if(a.urlError!==undefined){a.urlError(c,d)}}})}else{a.urlReady(this.blobUrl)}};IndexedDBURLContent.prototype.getBlob=function(k){if(k!==undefined){if(this.blob!=null){k.blobReady(this.blob)}else{var f=this.getURL();if(f.indexOf(IndexedDBURLContent.INDEXED_DB_PREFIX)>=0){var p=f.indexOf(IndexedDBURLContent.INDEXED_DB_PREFIX)+IndexedDBURLContent.INDEXED_DB_PREFIX.length;var j=f.indexOf("/",p);var r=f.indexOf("/",j+1);var n=f.indexOf("?",r+1);var c=f.indexOf("=",n+1);var g=f.indexOf("&",c+1);var o=f.substring(p,j);var e=f.substring(j+1,r);var a=f.substring(r+1,n);var h=f.substring(n+1,c);var q=decodeURIComponent(f.substring(c+1,g>0?g:f.length));var i=this;var l=function(s){var t=s.target.result;if(!t.objectStoreNames.contains(e)){t.createObjectStore(e,{keyPath:h})}};var m=function(s){if(k.blobError!==undefined){k.blobError(s.target.errorCode,"Can't connect to database "+o)}};var b=function(u){var x=u.target.result;try{if(!x.objectStoreNames.contains(e)){x.close();var w=indexedDB.open(o,x.version+1);w.addEventListener("upgradeneeded",l);w.addEventListener("error",m);w.addEventListener("success",b)}else{var y=x.transaction(e,"readonly");var s=y.objectStore(e);var v=s.get(q);v.addEventListener("error",function(z){if(k.blobError!==undefined){k.blobError(z.target.errorCode,"Can't query in "+e)}});v.addEventListener("success",function(B){if(B.target.result!==undefined){i.blob=B.target.result[a];for(var A in B.target.result){var z=B.target.result[A];if(z!==h&&z!=a&&i.blob[z]===undefined){i.blob[z]=B.target.result[z]}}i.blobUrl=URL.createObjectURL(i.blob);if(k.blobReady!==undefined){k.blobReady(i.blob)}}else{if(k.blobError!==undefined){k.blobError(-1,"Blob with key "+q+" not found")}}});y.addEventListener("complete",function(z){x.close()})}}catch(t){if(k.blobError!==undefined){k.blobError(t,t.message)}}};if(indexedDB!=null){var d=indexedDB.open(o);d.addEventListener("upgradeneeded",l);d.addEventListener("error",m);d.addEventListener("success",b)}else{k.blobError(new Error("indexedDB"),"indexedDB unavailable")}}else{if(k.urlError!==undefined){k.urlError(1,f+" not an indexedDB url")}}}}return this.blob};IndexedDBURLContent.prototype.isStreamURLReady=function(){return this.blobUrl!=null};var OperatingSystem={};OperatingSystem.isLinux=function(){if(navigator&&navigator.platform){return navigator.platform.indexOf("Linux")!==-1}else{return false}};OperatingSystem.isWindows=function(){if(navigator&&navigator.platform){return navigator.platform.indexOf("Windows")!==-1||navigator.platform.indexOf("Win")!==-1}else{return false}};OperatingSystem.isMacOSX=function(){if(navigator&&navigator.platform){return navigator.platform.indexOf("Mac")!==-1}else{return false}};OperatingSystem.getName=function(){if(OperatingSystem.isMacOSX()){return"Mac OS X"}else{if(OperatingSystem.isLinux()){return"Linux"}else{if(OperatingSystem.isWindows()){return"Windows"}else{return"Other"}}}};OperatingSystem.isInternetExplorerOrLegacyEdge=function(){return(document.documentMode||/Edge/.test(navigator.userAgent))};OperatingSystem.isInternetExplorer=function(){return document.documentMode};var ZIPTools={};ZIPTools.READING="Reading";ZIPTools.openedZips={};ZIPTools.runningRequests=[];ZIPTools.getZIP=function(d,b,a){if(a===undefined){a=b;b=false}if(d in ZIPTools.openedZips){a.zipReady(ZIPTools.openedZips[d])}else{var c=URLContent.fromURL(d);if(b&&!c.isStreamURLReady()){throw new IllegalStateException("Can't run synchronously with unavailable URL")}c.getStreamURL({urlReady:function(e){try{var g=new XMLHttpRequest();g.open("GET",e,!b);g.responseType="arraybuffer";g.withCredentials=true;g.overrideMimeType("application/octet-stream");g.addEventListener("readystatechange",function(k){if(g.readyState===XMLHttpRequest.DONE){if((g.status===200||g.status===0)&&g.response!=null){try{ZIPTools.runningRequests.splice(ZIPTools.runningRequests.indexOf(g),1);var j=new JSZip(g.response);ZIPTools.openedZips[d]=j;a.zipReady(ZIPTools.openedZips[d])}catch(i){a.zipError(i)}}else{var h=ZIPTools.runningRequests.indexOf(g);if(h>=0){ZIPTools.runningRequests.splice(h,1);a.zipError(new Error(g.status+" while requesting "+d))}}}});g.addEventListener("progress",function(h){if(h.lengthComputable&&a.progression!==undefined){a.progression(ZIPTools.READING,d,h.loaded/h.total)}});g.send();ZIPTools.runningRequests.push(g)}catch(f){a.zipError(f)}},urlError:function(e,f){if(a.zipError!==undefined){a.zipError(f)}}})}};ZIPTools.clear=function(){ZIPTools.openedZips={};while(ZIPTools.runningRequests.length>0){var a=ZIPTools.runningRequests[ZIPTools.runningRequests.length-1];ZIPTools.runningRequests.splice(ZIPTools.runningRequests.length-1,1);a.abort()}};ZIPTools.disposeZIP=function(a){delete ZIPTools.openedZips[a]};ZIPTools.isGIFImage=function(a){if(a.length<=6){return false}else{if(typeof a==="string"){return a.charAt(0).charCodeAt(0)===71&&a.charAt(1).charCodeAt(0)===73&&a.charAt(2).charCodeAt(0)===70&&a.charAt(3).charCodeAt(0)===56&&(a.charAt(4).charCodeAt(0)===55||a.charAt(4).charCodeAt(0)===57)&&a.charAt(5).charCodeAt(0)===97}else{return a[0]===71&&a[1]===73&&a[2]===70&&a[3]===56&&(a[4]===55||a[4]===57)&&a[5]===97}}};ZIPTools.isBMPImage=function(a){if(a.length<=2){return false}else{if(typeof a==="string"){return a.charAt(0).charCodeAt(0)===66&&a.charAt(1).charCodeAt(0)===77}else{return a[0]===66&&a[1]===77}}};ZIPTools.isJPEGImage=function(a){if(a.length<=3){return false}else{if(typeof a==="string"){return a.charAt(0).charCodeAt(0)===255&&(a.charAt(1).charCodeAt(0)===216||a.charAt(1).charCodeAt(0)===79)&&a.charAt(2).charCodeAt(0)===255}else{return a[0]===255&&(a[1]===216||a[1]===79)&&a[2]===255}}};ZIPTools.isPNGImage=function(a){if(a.length<=8){return false}else{if(typeof a==="string"){return a.charAt(0).charCodeAt(0)===137&&a.charAt(1).charCodeAt(0)===80&&a.charAt(2).charCodeAt(0)===78&&a.charAt(3).charCodeAt(0)===71&&a.charAt(4).charCodeAt(0)===13&&a.charAt(5).charCodeAt(0)===10&&a.charAt(6).charCodeAt(0)===26&&a.charAt(7).charCodeAt(0)===10}else{return a[0]===137&&a[1]===80&&a[2]===78&&a[3]===71&&a[4]===13&&a[5]===10&&a[6]===26&&a[7]===10}}};ZIPTools.isTransparentImage=function(a){return ZIPTools.isPNGImage(a)&&a.length>26&&(a.charAt(25).charCodeAt(0)===4||a.charAt(25).charCodeAt(0)===6||(a.indexOf("PLTE")!==-1&&a.indexOf("tRNS")!==-1))};ZIPTools.getScriptFolder=function(b){if(b===undefined){b="jszip.min.js"}if(typeof document!=="undefined"){var a=document.getElementsByTagName("script");for(var c=0;c<a.length;c++){if(b instanceof RegExp&&a[c].src.match(b)||typeof b==="string"&&a[c].src.indexOf(b)!==-1){return a[c].src.substring(0,a[c].src.lastIndexOf("/")+1)}}if(a.length>0){return a[0].src.substring(0,a[0].src.lastIndexOf("/")+1)}}return"https://www.sweethome3d.com/libjs/"};function HomeRecorder(a){this.configuration=a!==undefined?a:{}}HomeRecorder.READING_HOME="Reading home";HomeRecorder.PARSING_HOME="Parsing home";HomeRecorder.prototype.readHome=function(d,c){if(c.progression!==undefined){c.progression(HomeRecorder.READING_HOME,d,0)}var b="Home.xml";if(d.indexOf("jar:")===0){var e=d.indexOf("!/");b=d.substring(e+2);d=d.substring(4,e)}var a=this;ZIPTools.getZIP(d,{zipReady:function(h){try{var i=h.file(b);if(i!==null){var g={homeLoaded:function(j){a.replaceHomeContents(j,d,c)},homeError:function(j){if(c.homeError!==undefined){c.homeError(j)}},progression:function(k,l,j){if(c.progression!==undefined){c.progression(j)}}};a.parseHomeXMLEntry(i,h,d,typeof ContentDigestManager==="undefined"?c:g)}else{this.zipError(new Error("No "+b+" entry in "+d))}}catch(f){this.zipError(f)}},zipError:function(f){if(c.homeError!==undefined){c.homeError(f)}},progression:function(g,h,f){if(c.progression!==undefined){c.progression(HomeRecorder.READING_HOME,d,f)}}})};HomeRecorder.prototype.parseHomeXMLEntry=function(h,e,f,b){var g=h.asText();if(b.progression!==undefined){b.progression(HomeRecorder.READING_HOME,h.name,1);b.progression(HomeRecorder.PARSING_HOME,h.name,0)}var d=this.getHomeXMLHandler();d.homeUrl=f;var a=new SAXParser(d,d,d,d,d);try{g=g.replace(/\'/g,'"');a.parseString(g);b.homeLoaded(d.getHome())}catch(c){if(b.homeError!==undefined){b.homeError(c)}}if(b.progression!==undefined){b.progression(HomeRecorder.PARSING_HOME,h.name,1)}};HomeRecorder.prototype.getHomeXMLHandler=function(){return new HomeXMLHandler()};HomeRecorder.cacheResourcesStoredInContentDigestManager=false;HomeRecorder.prototype.replaceHomeContents=function(E,e,y){if(!HomeRecorder.cacheResourcesStoredInContentDigestManager&&this.configuration.listCacheResourcesURL&&this.configuration.readCacheResourceURL){var k=this;var f=ContentDigestManager.getInstance();var g=this.configuration.listCacheResourcesURL;if(g.indexOf(LocalStorageURLContent.LOCAL_STORAGE_PREFIX)===0){var u=g.substring(g.indexOf(LocalStorageURLContent.LOCAL_STORAGE_PREFIX)+LocalStorageURLContent.LOCAL_STORAGE_PREFIX.length);var m=new RegExp(u.indexOf("?")>0?u.substring(0,u.indexOf("?")):u);var A=Object.getOwnPropertyNames(localStorage);var w=[];for(var B=0;B<A.length;B++){var r=A[B].match(m);if(r){w.push(A[B])}}if(w.length>0){for(var B=w.length-1;B>=0;B--){var I=localStorage.getItem(w[B]);var D=I.substring("data:".length,I.indexOf(";"));var t=atob(I.substring(I.indexOf(",")+1));var o=new Array(t.length);for(var z=0;z<o.length;z++){o[z]=t.charCodeAt(z)}var q=new Uint8Array(o);var s=new BlobURLContent(new Blob([q],{type:D}));f.getContentDigest(s,{key:w[B],blobContentUrl:s,digestReady:function(J,K){URL.revokeObjectURL(this.blobContentUrl);var j=this.key.match(m);var i=URLContent.fromURL(CoreTools.format(k.configuration.readCacheResourceURL.replace(/(%[^s])/g,"%$1"),encodeURIComponent(j.length>1?j[1]:j[0])));f.setContentDigest(i,K);w.splice(w.lastIndexOf(this.key),1);if(w.length===0){k.replaceOrExtractHomeContents(E,e,y)}},digestError:function(i,j){URL.revokeObjectURL(this.blobContentUrl);console.warn("Can't retrieve cache content digest: "+j)}})}}else{k.replaceOrExtractHomeContents(E,e,y)}}else{if(g.indexOf(IndexedDBURLContent.INDEXED_DB_PREFIX)===0){var H=g.indexOf(IndexedDBURLContent.INDEXED_DB_PREFIX)+IndexedDBURLContent.INDEXED_DB_PREFIX.length;var v=g.indexOf("/",H);var F=g.indexOf("?",v+1);var b=g.indexOf("=",F+1);var l=g.indexOf("&",b+1);var G=g.substring(H,v);var d=g.substring(v+1,F);var n=g.substring(F+1,b);var m=new RegExp(g.substring(b+1,l>0?l:g.length));var x=function(i){var j=i.target.result;if(!j.objectStoreNames.contains(d)){j.createObjectStore(d,{keyPath:n})}};var C=function(i){console.warn("Can't connect to database "+G);k.replaceOrExtractHomeContents(E,e,y)};var a=function(J){var M=J.target.result;try{if(!M.objectStoreNames.contains(d)){M.close();var L=indexedDB.open(G,M.version+1);L.addEventListener("upgradeneeded",x);L.addEventListener("error",C);L.addEventListener("success",a)}else{var N=M.transaction(d,"readonly");var i=N.objectStore(d);var K;K=i.openCursor();K.addEventListener("success",function(R){var S=R.target.result;if(S!=null){var Q=S.primaryKey.match(m);if(Q){var P=Q.length>1?Q[1]:Q[0];var O=URLContent.fromURL(CoreTools.format(k.configuration.readCacheResourceURL.replace(/(%[^s])/g,"%$1"),encodeURIComponent(P)));f.setContentDigest(O,S.value.digest)}S["continue"]()}else{k.replaceOrExtractHomeContents(E,e,y)}});K.addEventListener("error",function(O){console.warn("Can't query in "+d);k.replaceOrExtractHomeContents(E,e,y)});N.addEventListener("complete",function(O){M.close()})}}catch(j){console.warn("Issue in "+d+": "+j.message);k.replaceOrExtractHomeContents(E,e,y)}};if(indexedDB!=null){var c=indexedDB.open(G);c.addEventListener("upgradeneeded",x);c.addEventListener("error",C);c.addEventListener("success",a)}else{if(y.homeError!==undefined){console.warn("indexedDB unavailable");k.replaceOrExtractHomeContents(E,e,y)}}}else{var c=new XMLHttpRequest();var p=g.indexOf("?")!=-1?"&":"?";c.open("GET",g+p+"requestId="+UUID.randomUUID(),true);c.addEventListener("load",function(L){if(c.readyState===XMLHttpRequest.DONE&&c.status===200){var M=JSON.parse(c.responseText);for(var K=0;K<M.length;K++){var J=M[K].name;var j=URLContent.fromURL(CoreTools.format(k.configuration.readCacheResourceURL.replace(/(%[^s])/g,"%$1"),encodeURIComponent(J)));f.setContentDigest(j,M[K].digest)}}else{if(y.homeError!==undefined){console.warn("Error while requesting "+g)}}k.replaceOrExtractHomeContents(E,e,y)});if(y.homeError!==undefined){var h=function(i){console.warn("Error while requesting "+g);k.replaceOrExtractHomeContents(E,e,y)};c.addEventListener("error",h);c.addEventListener("timeout",h)}c.send();return c}}HomeRecorder.cacheResourcesStoredInContentDigestManager=true}else{this.replaceOrExtractHomeContents(E,e,y)}};HomeRecorder.prototype.replaceOrExtractHomeContents=function(h,g,d){var a=[];this.searchContents(h,[],a,function(i){return i instanceof HomeURLContent});if(a.length>0){var c=this;var f=a.slice(0).reverse();var b=ContentDigestManager.getInstance();for(var e=f.length-1;e>=0;e--){b.getContentDigest(f[e],{homeContent:f[e],digestReady:function(r,q){f.splice(f.lastIndexOf(r),1);if(f.length===0){var v=[];c.searchContents(h,[],v,function(j){return j instanceof HomeURLContent&&b.getPermanentContentDigest(j)!=null},function(w){var j=b.getPermanentContentDigest(w);if(j.getURL().indexOf(".extract",j.getURL().length-".extract".length)>0){return URLContent.fromURL("jar:"+j.getURL()+"!/data")}else{if(w.isJAREntry()&&w.getJAREntryName().indexOf("/")>0&&!j.isJAREntry()){return URLContent.fromURL("jar:"+j.getURL()+"!/"+w.getJAREntryName().substring(w.getJAREntryName().indexOf("/")+1))}else{return j}}});var u=a.length-v.length;if(u>0&&c.configuration.readCacheResourceURL&&c.configuration.writeCacheResourceURL){var i=c.configuration.writeCacheResourceURL.indexOf(LocalStorageURLContent.LOCAL_STORAGE_PREFIX)<0&&c.configuration.writeCacheResourceURL.indexOf(IndexedDBURLContent.INDEXED_DB_PREFIX)<0?5:0;var s=function(){if(--u===0){ZIPTools.disposeZIP(g);c.searchContents(h,[],v,function(j){return j instanceof HomeURLContent},function(w){var j=n[w.getURL()];return j!==undefined?j:w});d.homeLoaded(h)}};var l=function(x,j,w,z){var y=UUID.randomUUID();if(z!=null){y+=z}b.getContentDigest(x,{digestReady:function(A,B){new BlobURLContent(j).writeBlob(c.configuration.writeCacheResourceURL,[y,B],{blobSaved:function(E,F){var D=CoreTools.format(c.configuration.readCacheResourceURL.replace(/(%[^s])/g,"%$1"),encodeURIComponent(F));if(w!=null){D="jar:"+D+"!/"+w}var C=URLContent.fromURL(D);n[x.getURL()]=C;b.setContentDigest(C,B);s()},blobError:function(C,D){console.warn("Can't saved all home extracted data: "+D);s()}})}})};var n={};for(var p=0;p<a.length;p++){var t=a[p];if(v.indexOf(t)<0){var k=t.getJAREntryName();var m=k.indexOf("/");if(m>0){var o=new JSZip();c.writeHomeZipEntries(o,"",t,{blobContentEntryName:k.substring(m+1),contentSaved:function(j){l(j,c.generateZip(o,i,"blob"),this.blobContentEntryName)},contentError:function(j,w){console.warn("Can't extract all home data: "+w);s()}})}else{t.getStreamURL({homeContent:t,urlReady:function(w){if(w.indexOf("jar:")===0){var x=w.indexOf("!/");var y=decodeURIComponent(w.substring(x+2));var j=w.substring(4,x);ZIPTools.getZIP(j,false,{homeContent:this.homeContent,zipReady:function(C){try{var z=C.file(y);var D=z.asUint8Array();if(ZIPTools.isPNGImage(D)||ZIPTools.isGIFImage(D)||ZIPTools.isJPEGImage(D)||ZIPTools.isBMPImage(D)){l(this.homeContent,new Blob([D]))}else{var A=new JSZip();c.writeZipEntry(A,"data",this.homeContent,{contentSaved:function(E){l(E,c.generateZip(A,i,"blob"),"data",".extract")},contentError:function(E,F){console.warn("Can't extract all home data: "+F);s()}})}}catch(B){this.zipError(B)}},zipError:function(z){console.warn("Can't extract all home data: "+z);s()}})}},urlError:function(j,w){console.warn("Can't extract all home data: "+w);s()}})}}}}else{ZIPTools.disposeZIP(g);d.homeLoaded(h)}}},digestError:function(i,j){console.warn("Can't retrieve home content digest: "+j);f.splice(f.lastIndexOf(this.homeContent),1);if(f.length===0){d.homeLoaded(h)}}})}}else{d.homeLoaded(h)}};HomeRecorder.prototype.writeHome=function(m,h,l){var g=this.configuration.includeAllContent!==undefined?this.configuration.includeAllContent:true;var n=this.configuration.writeDataType!==undefined?this.configuration.writeDataType:"blob";var d=[];this.searchContents(m,[],d);var b=false;var o=null;if(d.length>0){var p=this;var f=d.slice(0);var k=[];var a={};var q=0;var c=ContentDigestManager.getInstance();for(var e=f.length-1;e>=0;e--){var j=f[e];if(j instanceof LocalURLContent||(j.isJAREntry()&&URLContent.fromURL(j.getJAREntryURL()) instanceof LocalURLContent)||j instanceof HomeURLContent||j instanceof SimpleURLContent||g){c.getContentDigest(j,{digestReady:function(w,v){var u=false;if(v!==undefined){for(var s=0;s<k.length;s++){var y=k[s];if(w.getURL()!==y.getURL()&&c.equals(w,y)){a[w.getURL()]=a[y.getURL()];d.splice(d.indexOf(w),1);u=true;break}}}if(!u){var r="";if(w.isJAREntry()){var x=w.getJAREntryName();if(w instanceof HomeURLContent){var i=x.indexOf("/");if(i>0){r=x.substring(i)}}else{if(!(w instanceof SimpleURLContent)){r="/"+x}}}var t=q+++r;a[w.getURL()]=t;k.push(w)}f.splice(f.lastIndexOf(w),1);if(f.length===0&&!b){o=p.writeHomeToZip(m,h,d,a,n,l)}},digestError:function(i,r){if(l.homeError!==undefined){l.homeError(i,r)}}})}else{d.splice(e,1);f.splice(f.lastIndexOf(j),1);if(f.length===0&&!b){o=p.writeHomeToZip(m,h,d,a,n,l)}}}}else{o=this.writeHomeToZip(m,h,d,{},n,l)}return{abort:function(){b=true;if(o!=null){o.abort()}}}};HomeRecorder.prototype.writeHomeToZip=function(o,j,n,b,p,m){var h=o.clone();h.setName(j);var f=new StringWriter();var c=this.getHomeXMLExporter();c.setSavedContentNames(b);c.writeElement(new XMLWriter(f),h);var k=f.toString();if((!OperatingSystem.isInternetExplorer()||n.length==0)&&this.configuration.writeHomeWithWorker){if(this.writeHomeWorker==null){var a=new Blob(["importScripts('"+ZIPTools.getScriptFolder()+"jszip.min.js');importScripts('"+(document.getElementById("recorder-worker")!=null?document.getElementById("recorder-worker").src:ZIPTools.getScriptFolder("URLContent.js")+"URLContent.js', '"+ZIPTools.getScriptFolder("HomeRecorder.js")+"HomeRecorder.js")+"');onmessage = function(ev) {  new HomeRecorder(ev.data.recorderConfiguration).generateHomeZip(      ev.data.homeXmlEntry, ev.data.homeContents, ev.data.homeContentTypes, ev.data.savedContentNames, ev.data.dataType, {         homeSaved: function(homeXmlEntry, data) {            postMessage(data);         },         homeError: function(status, error) {            postMessage({status: status, error: error});         }    });}"],{type:"text/plain"});this.writeHomeWorker=new Worker(URL.createObjectURL(a))}var q=this;var l=function(i){q.writeHomeWorker.removeEventListener("message",l);if(i.data.error){if(i.data.error==="indexedDB unavailable"){console.warn("Can't use worker to save home");q.writeHomeToZipWithoutWorker(o,k,n,b,p,m)}else{if(m.homeError!==undefined){m.homeError(i.data.status,i.data.error)}}}else{m.homeSaved(o,i.data)}};this.writeHomeWorker.addEventListener("message",l);var e=new Array(n.length);for(var g=0;g<n.length;g++){var d=Object.getPrototypeOf(n[g]).constructor;if(d!==undefined&&d.name!==undefined){e[g]=d.name}else{e[g]=n[g].constructor.toString().match(/function (\w*)/)[1]}}this.writeHomeWorker.postMessage({recorderConfiguration:this.configuration,homeXmlEntry:k,homeContents:n,homeContentTypes:e,savedContentNames:b,dataType:p});return{abort:function(){if(q.writeHomeWorker!=null){q.writeHomeWorker.terminate()}q.writeHomeWorker=null}}}else{this.writeHomeToZipWithoutWorker(o,k,n,b,p,m)}};HomeRecorder.prototype.writeHomeToZipWithoutWorker=function(f,e,a,d,c,b){this.generateHomeZip(e,a,null,d,c,{homeSaved:function(h,g){b.homeSaved(f,g)},homeError:function(g,h){if(b.homeError!==undefined){b.homeError(g,h)}}});return{abort:function(){}}};HomeRecorder.prototype.generateHomeZip=function(l,n,e,b,o,m){var j=new JSZip();j.file("Home.xml",l);if(n.length>0){if(e!==null){for(var g=0;g<n.length;g++){var h=b[n[g].url];switch(e[g]){case"SimpleURLContent":n[g]=new SimpleURLContent(n[g].url);break;case"HomeURLContent":n[g]=new HomeURLContent(n[g].url);break;case"BlobURLContent":n[g]=new BlobURLContent(n[g].blob);break;default:n[g]=URLContent.fromURL(n[g].url);if(n[g] instanceof LocalStorageURLContent){m.homeError(0,"Data from localstorage not supported in workers");return}break}b[n[g].getURL()]=h}}var p=this;var f=n.slice(0).reverse();var a={contentSaved:function(i){f.splice(f.lastIndexOf(i),1);if(f.length===0){m.homeSaved(l,p.generateZip(j,p.configuration.compressionLevel,o))}},contentError:function(i,q){m.homeError(i,q)}};for(var g=f.length-1;g>=0;g--){var k=f[g];var c=b[k.getURL()];if(c!==undefined){var d=c.indexOf("/");if(d>0){c=c.substring(0,d)}if(!(k instanceof SimpleURLContent)&&k.isJAREntry()){if(k instanceof HomeURLContent){this.writeHomeZipEntries(j,c,k,a)}else{this.writeZipEntries(j,c,k,a)}}else{this.writeZipEntry(j,c,k,a)}}else{a.contentSaved(k)}}}else{m.homeSaved(l,this.generateZip(j,this.configuration.compressionLevel,o))}};HomeRecorder.prototype.generateZip=function(d,e,b){var a=e!==undefined&&e===0?"STORE":"DEFLATE";var c=e!==undefined?e:1;return d.generate({type:b,compression:a,compressionOptions:{level:c}})};HomeRecorder.prototype.writeHomeZipEntries=function(f,b,e,a){var g=e.getJAREntryName();var d=g.indexOf("/");if(d>0){var c=e.getJAREntryURL();var i=g.substring(0,d+1);var h=this;URLContent.fromURL(e.getJAREntryURL()).getStreamURL({urlReady:function(j){ZIPTools.getZIP(j,false,{zipReady:function(o){try{var k=o.file(new RegExp("^"+i+".*")).reverse();for(var n=k.length-1;n>=0;n--){var p=k[n];var m=new URLContent("jar:"+c+"!/"+encodeURIComponent(p.name).replace("+","%20"));h.writeZipEntry(f,b.length>0?b+p.name.substring(d):p.name.substring(d+1),m,{zipEntry:p,contentSaved:function(q){k.splice(k.lastIndexOf(this.zipEntry),1);if(k.length===0){a.contentSaved(e)}},contentError:function(q,r){a.contentError(q,r)}})}}catch(l){this.zipError(l)}},zipError:function(k){a.contentError(k,k.message)}})},urlError:function(j,k){a.contentError(j,k)}})}else{this.writeZipEntry(f,b,e,a)}};HomeRecorder.prototype.writeZipEntries=function(e,a,c,d){var b=this;URLContent.fromURL(c.getJAREntryURL()).getStreamURL({urlReady:function(f){ZIPTools.getZIP(f,false,{zipReady:function(l){try{var g=l.file(/.*/).reverse();for(var k=g.length-1;k>=0;k--){var m=g[k];var j=new URLContent("jar:"+c.getJAREntryURL()+"!/"+encodeURIComponent(m.name).replace("+","%20"));b.writeZipEntry(e,a+"/"+m.name,j,{zipEntry:m,contentSaved:function(i){g.splice(g.lastIndexOf(this.zipEntry),1);if(g.length===0){d.contentSaved(c)}},contentError:function(i,n){d.contentError(i,n)}})}}catch(h){this.zipError(h)}},zipError:function(g){d.contentError(g,g.message)}})},urlError:function(f,g){d.contentError(f,g)}})};HomeRecorder.prototype.writeZipEntry=function(d,c,b,a){b.getStreamURL({urlReady:function(f){if(f.indexOf("jar:")===0){var h=f.indexOf("!/");var i=decodeURIComponent(f.substring(h+2));var e=f.substring(4,h);ZIPTools.getZIP(e,false,{zipReady:function(l){try{var j=l.file(i);d.file(c,j.asUint8Array(),{binary:true});a.contentSaved(b)}catch(k){this.zipError(k)}},zipError:function(j){a.contentError(j,j.message)}})}else{var g=new XMLHttpRequest();g.open("GET",f,true);g.responseType="arraybuffer";g.addEventListener("load",function(){d.file(c,g.response);a.contentSaved(b)});g.send()}},urlError:function(e,f){a.contentError(e,f)}})};HomeRecorder.prototype.getHomeXMLExporter=function(){return new HomeXMLExporter()};HomeRecorder.prototype.searchContents=function(e,a,c,m,h){if(Array.isArray(e)){for(var g=0;g<e.length;g++){var l=this.searchContents(e[g],a,c,m,h);if(l!==null){e[g]=l}}}else{if(e instanceof URLContent&&(m===undefined||m(e))){var g=0;for(;g<c.length;g++){if(c[g].getURL()==e.getURL()){break}}if(g===c.length){c.push(e)}if(h!==undefined){return h(e)}else{return null}}else{if(e!=null&&typeof e!=="number"&&typeof e!=="string"&&typeof e!=="boolean"&&typeof e!=="function"&&!(e instanceof URLContent)&&a.indexOf(e)<0){a.push(e);var b=Object.getOwnPropertyNames(e);for(var f=0;f<b.length;f++){var k=b[f];if(k=="object3D"||e.constructor&&e.constructor.__transients&&e.constructor.__transients.indexOf(k)!=-1){continue}var d=e[k];var l=this.searchContents(d,a,c,m,h);if(l!==null){e[k]=l}}}}}return null};