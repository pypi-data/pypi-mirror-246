 # nginx配置文件
 # compose/nginx/nginx.conf
# 开启gzip
gzip on;
# 启用gzip压缩的最小文件，小于设置值的文件将不会压缩
gzip_min_length 1k;
# gzip 压缩级别，1-9，数字越大压缩的越好，也越占用CPU时间，后面会有详细说明
gzip_comp_level 5;
# 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。
gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml;
# 是否在http header中添加Vary: Accept-Encoding，建议开启
gzip_vary on;
# 禁用IE 6 gzip
gzip_disable "MSIE [1-6]\.";
# 设置压缩所需要的缓冲区大小
gzip_buffers 32 4k;
upstream BaseServer {
    server 127.0.0.1:9999; # 智慧办公基础服务
    keepalive 2000;
}
upstream BaseWsServer {
    server 127.0.0.1:9852; # 智慧办公基础WebSocket服务
    keepalive 2000;
}
upstream YwjServerWs {
    server 127.0.0.1:10000; # 云问卷
    keepalive 2000;
}
upstream WpsOnlineServer {
    server 127.0.0.1:10001; # 协同办公
    keepalive 2000;
}
upstream SoH5Server {
    server 127.0.0.1:10002; # H5
    keepalive 2000;
}
upstream PosterServer {
    server 127.0.0.1:10003; # 海报
    keepalive 2000;
}
upstream MeetingServer {
    server 127.0.0.1:10004; # 会议通
    keepalive 2000;
}
upstream PagexServer {
    server 127.0.0.1:10005; # 个人建站
    keepalive 2000;
}
upstream ViewServer {
    server 127.0.0.1:10006; # 大屏可视化
    keepalive 2000;
}
upstream n8nServer {
    server 127.0.0.1:10007; # n8n
    keepalive 2000;
}
upstream taskServer {
    server 127.0.0.1:10008; # 任务通
    keepalive 2000;
}
upstream ToolsServer {
    server 127.0.0.1:10100; # 工具箱
    keepalive 2000;
}
#access_log /home/nginx/log/access.log main;
#error_log /home/nginx/log/error.log warn;
server_tokens off;
server {
     listen 80; # 监听9090端口
     server_name 127.0.0.1; # 可以是nginx容器所在ip地址或127.0.0.1，不能写宿主机外网ip地址
     #rewrite ^(.*) https://$server_name$1 permanent; # 强制跳转https
     charset utf-8;
     client_max_body_size 1024M; # 限制用户上传文件大小
     location /static {
         alias /usr/share/nginx/html/static; # 静态资源路径
     }
     location /media {
         alias /usr/share/nginx/html/media; # 媒体资源，用户上传文件路径
     }
     # 智慧办公基础服务
     location /sobase/api {
         include /etc/nginx/uwsgi_params;
         uwsgi_pass BaseServer;
         uwsgi_read_timeout 600;
         uwsgi_connect_timeout 600;
         uwsgi_send_timeout 600;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header Host $http_host;
         proxy_redirect off;
         proxy_set_header X-Real-IP  $remote_addr;
         #proxy_set_header X-Forwarded-For $http_x_forwarded_for; # $http_x_forwarded_for变量 = X-Forwarded-For变量
    }
    # 智慧办公基础服务WebSocket
    location /sobase/ws {
        proxy_send_timeout 3600;
        proxy_connect_timeout 3600;
        proxy_read_timeout 3600;
        proxy_pass http://BaseWsServer;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $server_name;
    }
    location / {
        root  /usr/share/nginx/html;
        index index.html index.htm;
    }
}