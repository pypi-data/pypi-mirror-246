"use strict";(self.webpackChunk_jupytercad_jupytercad_lab=self.webpackChunk_jupytercad_jupytercad_lab||[]).push([[41,978],{9978:(e,t,s)=>{s.r(t),s.d(t,{IJupyterYWidgetManager:()=>_,JupyterYDoc:()=>n,JupyterYModel:()=>o,default:()=>D,notebookRenderer:()=>C,yWidgetManager:()=>k});var i=s(7930),r=s(4901),d=s(981);class o{constructor(e){this._isDisposed=!1,this._disposed=new r.Signal(this),this._yModelName=e.ymodel_name;const t=this.ydocFactory(e);this._sharedModel=new n(e,t)}get yModelName(){return this._yModelName}get sharedModel(){return this._sharedModel}get sharedAttrsChanged(){return this.sharedModel.attrsChanged}get disposed(){return this._disposed}get isDisposed(){return this._isDisposed}ydocFactory(e){return new d.Doc}dispose(){this._isDisposed||(this._isDisposed=!0,this._sharedModel.dispose(),this._disposed.emit(),r.Signal.clearData(this))}addAttr(e,t){this.sharedModel.setAttr(e,t)}removeAttr(e){this.sharedModel.removeAttr(e)}}class n{constructor(e,t){this._attrsObserver=e=>{this._attrsChanged.emit(e.keys)},this._attrsChanged=new r.Signal(this),this._isDisposed=!1,this._disposed=new r.Signal(this),this._commMetadata=e,this._ydoc=t,e.create_ydoc&&(this._attrs=this._ydoc.getMap("_attrs"),this._attrs.observe(this._attrsObserver))}get commMetadata(){return this._commMetadata}get ydoc(){return this._ydoc}get attrs(){return i.JSONExt.deepCopy(this._attrs.toJSON())}get attrsChanged(){return this._attrsChanged}get disposed(){return this._disposed}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._attrs.unobserve(this._attrsObserver),this._disposed.emit(),r.Signal.clearData(this),this._isDisposed=!0)}getAttr(e){return this._attrs.get(e)}setAttr(e,t){this._attrs.set(e,t)}removeAttr(e){this._attrs.has(e)&&this._attrs.delete(e)}}var a=s(9122),c=s(9499);class h{constructor(e){this._isDisposed=!1,this._widgetManager=e.widgetManager,this._kernelId=e.kernelId}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._isDisposed=!0)}getYModel(e){if(this._kernelId)return this._widgetManager.getWidgetModel(this._kernelId,e)}createYWidget(e,t){if(this._kernelId){const s=this._widgetManager.getWidgetModel(this._kernelId,e);s&&new(this._widgetManager.getWidgetFactory(s.yModelName))(s,t)}}}const _=new i.Token("yjs-widgets:IJupyterYWidgetManager","A manager of Yjs-based Jupyter widgets.");var g=s(8778);class l extends g.Widget{constructor(e){super(),this._modelFactory=e.modelFactory,this._mimeType=e.mimeType,this.addClass("mimerenderer-jupyterywidget")}dispose(){var e;this.isDisposed||(null===(e=this._yModel)||void 0===e||e.dispose(),super.dispose())}async renderModel(e){const t=e.data[this._mimeType].model_id;this._yModel=this._modelFactory.getYModel(t),this._yModel&&this._modelFactory.createYWidget(t,this.node)}}var y,u,p=s(2256),m=s(9476),M=s(8078);!function(e){e[e.SYNC=0]="SYNC",e[e.AWARENESS=1]="AWARENESS"}(y||(y={}));class w{constructor(e){this._onMsg=e=>{if(e.buffers){const t=e.buffers[0],s=new Uint8Array(ArrayBuffer.isView(t)?t.buffer:t),i=u.readMessage(this,s,!0);m.kE(i)>1&&this._sendOverComm(m._f(i))}},this._updateHandler=(e,t)=>{const s=m.Mf();m.uE(s,y.SYNC),M.lr(s,e),this._sendOverComm(m._f(s))},this._isDisposed=!1,this._comm=e.comm,this._ydoc=e.ydoc,this._ydoc.on("update",this._updateHandler),this._connect()}get doc(){return this._ydoc}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._comm.close(),this._isDisposed=!0)}_connect(){this._sync(),this._comm.onMsg=this._onMsg}_sync(){const e=m.Mf();m.uE(e,y.SYNC),M._J(e,this._ydoc),this._sendOverComm(m._f(e))}_sendOverComm(e){this._comm.send({},void 0,[e.buffer])}}!function(e){function t(e,t,s,i){m.uE(e,y.SYNC);const r=M.zu(t,e,s.doc,s);i&&r===M.Px&&!s.synced&&(M.K0(e,s.doc),s.synced=!0)}e.syncMessageHandler=t,e.readMessage=function(e,s,i){const r=p.l1(s),d=m.Mf();return p.yg(r)===y.SYNC?t(d,r,e,i):console.error("Unable to compute message"),d}}(u||(u={}));class v{constructor(){this._registry=new Map,this._yModelFactories=new Map,this._yWidgetFactories=new Map}registerKernel(e){const t=this._yModelFactories,s=new f({kernel:e,yModelFactories:t});this._registry.set(e.id,s)}unregisterKernel(e){e&&this._registry.delete(e)}registerWidget(e,t,s){this._yModelFactories.set(e,t),this._yWidgetFactories.set(e,s)}getWidgetModel(e,t){var s;return null===(s=this._registry.get(e))||void 0===s?void 0:s.getModel(t)}getWidgetFactory(e){return this._yWidgetFactories.get(e)}}class f{constructor(e){this._handle_comm_open=async(e,t)=>{const s=new(this._yModelFactories.get(t.metadata.ymodel_name))(t.metadata);new w({comm:e,ydoc:s.sharedModel.ydoc}),this._yModels.set(e.commId,s)},this._yModels=new Map;const{kernel:t,yModelFactories:s}=e;this._yModelFactories=s,t.registerCommTarget("ywidget",this._handle_comm_open)}getModel(e){return this._yModels.get(e)}}const C={id:"jupyterywidget:notebookRenderer",autoStart:!0,requires:[c.IRenderMimeRegistry,a.INotebookTracker,_],activate:(e,t,s,i)=>{const r={safe:!0,mimeTypes:["application/vnd.jupyter.ywidget-view+json"],createRenderer:e=>{var t,r,d;const o=null===(d=null===(r=null===(t=s.currentWidget)||void 0===t?void 0:t.sessionContext.session)||void 0===r?void 0:r.kernel)||void 0===d?void 0:d.id,n=e.mimeType,a=new h({kernelId:o,widgetManager:i});return new l({mimeType:n,modelFactory:a})}};t.addFactory(r,-100)}},k={id:"yjs-widgets:yWidgetManagerPlugin",autoStart:!0,requires:[a.INotebookTracker],provides:_,activate:(e,t)=>{const s=new v,i=(e,t)=>{const{newValue:i,oldValue:r}=t;i&&(s.unregisterKernel(null==r?void 0:r.id),s.registerKernel(i),i.disposed.connect((()=>{s.unregisterKernel(i.id)})))};return t.widgetAdded.connect((async(e,t)=>{t.sessionContext.kernelChanged.connect(i),t.disposed.connect((()=>{t.sessionContext.kernelChanged.disconnect(i)}))})),s}},D=[C,k]}}]);