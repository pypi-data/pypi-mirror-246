<!-- vim: syntax=javascript: 
-->

<script type="text/html" data-help-name="ax-join">
    <h1>AX Join Entry</h1>
    <p>
    Combine multiple messages.
    </p>
    <p>Auto should be the option you want most of the time, it combines previously split messages based on their msg ids.</p>

</script>


<script type="text/html" data-template-name="ax-join">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>

    <div class="node-row-custom">
        <div class="form-row node-row-property">
            <label>Combine msgs using</label>
            <input type="text" id="node-input-property" data-i18n="[placeholder]payload updater" style="width:70%">
        </div>
        <div class="form-row node-row-key">
            <label style="vertical-align:top; margin-top:7px; width:auto; margin-right: 5px;" data-i18n="ax-join.using"></label>
            <div style="display:inline-block">
                <input type="text" id="node-input-key" style="width:220px;"> <span data-i18n="ax-join.key"></span>
            </div>
        </div>
        <div class="form-row node-row-joiner">
            <label for="node-input-joiner">joined on</label>
            <input type="text" id="node-input-joiner" data-i18n="[placeholder]m[payload..." style="width:70%">
        </div>
        <div class="form-row node-row-trigger" id="trigger-row">
            <label style="width:auto;" data-i18n="ax-join.send"></label>
            <ul>
                <li>
                <label style="width:280px;" for="node-input-count">After a number of message parts</label>
                <input id="node-input-count" data-i18n="[placeholder]count" type="text" style="width:75px;">
                </li>
                <li class="node-row-accumulate" style="list-style-type:none;">
                    <input type="checkbox" id="node-input-accumulate" style="display:inline-block; width:20px; margin-left:20px; vertical-align:top;">  <label style="width: auto" for="node-input-accumulate" data-i18n="ax-join.subsequent"></label>
                </li>
                <li>
                    <label style="width:280px;" for="node-input-timeout" data-i18n="ax-join.afterTimeout"></label>
            <input id="node-input-timeout" data-i18n="[placeholder]ax-join.seconds" type="text" style="width:75px;">
                </li>
                <li>
                    <label style="width:auto; padding-top:6px;" data-i18n="[html]ax-join.complete"></label>
                </li>
            </ul>
        </div>
        <div class="form-row node-row_ipc">
            <label for="node-input-ipc-via">Auto IPC via</label>
            <input type="text" id="node-input-ipc_via" data-i18n="[placeholder]connection name" style="width:70%">
        </div>
         <hr/>
       <div class="form-row">
        <label>Mode</label>
        <select id="node-input-mode" style="width:200px;">
          <option value="custom">manual</option>
        <!--
          <option value="auto">automatic</option>
          <option value="reduce">reduce sequence</option>
        -->
        </select>
      </div>
        <div class="form-row">
            <label>Creating</label>
            <select id="node-input-build" style="width:70%;">
                <option value="merged" data-i18n="ax-join.type.merged"></option>
          <!--
                <option value="string" data-i18n="ax-join.type.string"></option>
                <option value="buffer" data-i18n="ax-join.type.buffer"></option>
                <option value="array" data-i18n="ax-join.type.array"></option>
                <option value="object" data-i18n="ax-join.type.object"></option>
            -->
            </select>
        </div>

    </div>
    <div class="node-row-reduce">
        <div class="form-row">
            <label for="node-input-reduceExp" data-i18n="ax-join.reduce.exp" style="margin-left:10px;"></label>
            <input type="text" id="node-input-reduceExp" data-i18n="[placeholder]ax-join.reduce.exp-value" style="width:65%">
        </div>
        <div class="form-row">
            <label for="node-input-reduceInit" data-i18n="ax-join.reduce.init" style="margin-left:10px;"></label>
            <input type="text" id="node-input-reduceInit" data-i18n="[placeholder]ax-join.reduce.init" style="width:65%">
            <input type="hidden" id="node-input-reduceInitType">
        </div>
        <div class="form-row">
            <label for="node-input-reduceFixup" data-i18n="ax-join.reduce.fixup" style="margin-left:10px;"></label>
            <input type="text" id="node-input-reduceFixup" data-i18n="[placeholder]ax-join.reduce.exp-value" style="width:65%">
        </div>
        <div class="form-row">
            <label>&nbsp;</label>
            <input type="checkbox" id="node-input-reduceRight" style="display:inline-block; width:auto; vertical-align:top; margin-left:10px;">
            <label for="node-input-reduceRight" style="width:70%;" data-i18n="ax-join.reduce.right" style="margin-left:10px;"/>
        </div>
    </div>
    <div class="form-tips form-tips-auto hide" data-i18n="[html]ax-join.tip"></div>
</script>

<script type="text/javascript">
  RED.nodes.registerType('ax-join', {
    category: 'axiros',
    color: "#D6F1AE",
    defaults: {
      name: {value: ""},
      mode: {value: "custom"},
      build: {value: "merged"},
      property: {value: "update_payload"},
      propertyType: {value: "Î»"},
      key: {value: "topic"},
      joiner: {value: "m[payload][id]"},
      joinerType: {value: "str"},
      accumulate: {value: "false"},
      timeout: {value: ""},
      count: {value: ""},
      ipc_via: {value: ""},
      reduceRight: {value: false},
      reduceExp: {value: undefined},
      reduceInit: {value: undefined},
      reduceInitType: {value: undefined},
      reduceFixup: {value: undefined}
    },
    inputs: 1,
    outputs: 1,
    icon: "join.svg",
    label: function () {
      return this.name;
      //return this.name||this._("join.join");
    },
    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },
    oneditprepare: function () {
      var node = this;
      this.property = this.property || 'payload';

      $("#node-input-mode").on("change", function (e) {
        var val = $(this).val();
        $(".node-row-custom").toggle(val === 'custom');
        $(".node-row-reduce").toggle(val === 'reduce');
        $(".form-tips-auto").toggle((val === 'auto') || (val === 'reduce'));
        if (val === "auto") {
          $("#node-input-accumulate").attr('checked', false);
        }
        else if (val === "custom") {
          $("#node-input-build").change();
        }
        // else if (val === "reduce") {
        //     var jsonata_or_empty = {
        //         value: "jsonata",
        //         label: "expression",
        //         icon: "red/images/typedInput/expr.png",
        //         validate: function(v) {
        //             try{
        //                 if(v !== "") {
        //                     jsonata(v);
        //                 }
        //                 return true;
        //             }
        //             catch(e){
        //                 return false;
        //             }
        //         },
        //         expand:function() {
        //             var that = this;
        //             RED.editor.editExpression({
        //                 value: this.value().replace(/\t/g,"\n"),
        //                 complete: function(v) {
        //                     that.value(v.replace(/\n/g,"\t"));
        //                 }
        //             })
        //         }
        //     };
        //     $("#node-input-reduceExp").typedInput({types:[jsonata_or_empty]});
        //     $("#node-input-reduceInit").typedInput({
        //         default: 'num',
        //         types:['flow','global','str','num','bool','json','bin','date','jsonata','env'],
        //         typeField: $("#node-input-reduceInitType")
        //     });
        //     $("#node-input-reduceFixup").typedInput({types:[jsonata_or_empty]});
        // }
      });

      $("#node-input-build").on("change", function (e) {
        var val = $(this).val();
        $(".node-row-key").toggle(val === 'object');
        $(".node-row-accumulate").toggle(val === 'object' || val === 'string');
        $(".node-row-joiner").toggle(true);
        $(".node-row-trigger").toggle(val !== 'auto');
        // if (val === 'merged' || val==='buffer') {
        //     $("#node-input-property").typedInput('types',['msg']);
        //     $("#node-input-joiner").typedInput("show");
        // } else {
        //     $("#node-input-property").typedInput('types', ['msg', {
        //         value: "full",
        //         label: RED._("node-red:join.completeMessage"),
        //         hasValue: false
        //     }]);
        // }
      });

      // $("#node-input-joiner").typedInput({
      //     default: 'str',
      //     typeField: $("#node-input-joinerType"),
      //     types:['str', 'bin']
      // });
      //
      // $("#node-input-property").typedInput({
      //     typeField: $("#node-input-propertyType"),
      //     types: ['msg', {
      //         value: "full",
      //         label: RED._("node-red:join.completeMessage"),
      //         hasValue: false
      //     }]
      // });

      $("#node-input-key").typedInput({
        types: ['msg']
      });

      $("#node-input-build").change();
      $("#node-input-mode").change();
    },
    oneditsave: function () {
      var build = $("#node-input-build").val();
      if (build !== 'object' && build !== 'merged') {
        $("#node-input-accumulate").prop("checked", false);
      }
    }
  });
</script>
