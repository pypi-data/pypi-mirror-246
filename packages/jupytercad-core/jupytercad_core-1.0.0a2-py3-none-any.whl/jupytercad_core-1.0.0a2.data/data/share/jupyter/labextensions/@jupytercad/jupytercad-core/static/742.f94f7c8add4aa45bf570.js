"use strict";(self.webpackChunk_jupytercad_jupytercad_core=self.webpackChunk_jupytercad_jupytercad_core||[]).push([[742],{3742:(e,o,r)=>{var t,n;r.r(o),r.d(o,{MainAction:()=>n,OCC_WORKER_ID:()=>T,OccParser:()=>s,OccWorker:()=>f,WorkerAction:()=>t}),function(e){e.LOAD_FILE="LOAD_FILE",e.SAVE_FILE="SAVE_FILE",e.REGISTER="REGISTER"}(t||(t={})),function(e){e.DISPLAY_SHAPE="DISPLAY_SHAPE",e.INITIALIZED="INITIALIZED"}(n||(n={}));class s{constructor(e){this._occ=self.occ,this._showEdge=!0,this._shapeList=e}execute(){const e={};return this._shapeList.forEach((o=>{const{shapeData:r,jcObject:t}=o,{occShape:n,metadata:s}=r;new this._occ.BRepMesh_IncrementalMesh_2(n,.1,!1,.5,!0);const a=this._build_face_mesh(n);let i=[];this._showEdge&&(i=this._build_edge_mesh(n));const p=this._build_wire_mesh(n,.1);e[t.name]={jcObject:t,faceList:a,edgeList:[...i,...p],meta:s}})),e}_build_wire_mesh(e,o){const r=[],t=this._occ,n=new t.TopExp_Explorer_2(e,t.TopAbs_ShapeEnum.TopAbs_EDGE,t.TopAbs_ShapeEnum.TopAbs_SHAPE);for(n.Init(e,t.TopAbs_ShapeEnum.TopAbs_EDGE,t.TopAbs_ShapeEnum.TopAbs_SHAPE);n.More();){const e=t.TopoDS.Edge_1(n.Current()),s=new t.TopLoc_Location_1,a=new t.BRepAdaptor_Curve_2(e),i=new t.GCPnts_TangentialDeflection_2(a,o,.1,2,1e-9,1e-7),p=new Array(3*i.NbPoints());for(let e=0;e<i.NbPoints();e++){const o=i.Value(e+1).Transformed(s.Transformation());p[3*e+0]=o.X(),p[3*e+1]=o.Y(),p[3*e+2]=o.Z()}r.push({vertexCoord:p,numberOfCoords:3*i.NbPoints()}),n.Next()}return r}_build_face_mesh(e){const o=[],r=[],t=this._occ,n=new t.TopExp_Explorer_2(e,t.TopAbs_ShapeEnum.TopAbs_FACE,t.TopAbs_ShapeEnum.TopAbs_SHAPE);for(n.Init(e,t.TopAbs_ShapeEnum.TopAbs_FACE,t.TopAbs_ShapeEnum.TopAbs_SHAPE);n.More();){const e=t.TopoDS.Face_1(n.Current()),s=new t.TopLoc_Location_1,a=t.BRep_Tool.Triangulation(e,s,0);if(a.IsNull()){console.error("Encountered Null Face!"),n.Next();continue}const i={vertexCoord:[],normalCoord:[],triIndexes:[],numberOfTriangles:0},p=new t.Poly_Connect_2(a),_=a.get(),c=_.NbNodes();i.vertexCoord=new Array(3*c);for(let e=0;e<c;e++){const o=_.Node(e+1).Transformed(s.Transformation());i.vertexCoord[3*e+0]=o.X(),i.vertexCoord[3*e+1]=o.Y(),i.vertexCoord[3*e+2]=o.Z()}const d=e.Orientation_1(),l=new t.TColgp_Array1OfDir_2(1,c);t.StdPrs_ToolTriangulatedShape.Normal(e,p,l),i.normalCoord=new Array(3*l.Length());for(let e=0;e<l.Length();e++){const o=l.Value(e+1).Transformed(s.Transformation());i.normalCoord[3*e+0]=o.X(),i.normalCoord[3*e+1]=o.Y(),i.normalCoord[3*e+2]=o.Z()}const u=_.NbTriangles();i.triIndexes=new Array(3*u);let h=0;for(let e=1;e<=a.get().NbTriangles();e++){const o=_.Triangle(e);let r=o.Value(1),n=o.Value(2);const s=o.Value(3);if(d!==t.TopAbs_Orientation.TopAbs_FORWARD){const e=r;r=n,n=e}i.triIndexes[3*h+0]=r-1,i.triIndexes[3*h+1]=n-1,i.triIndexes[3*h+2]=s-1,h++}i.numberOfTriangles=h,o.push(i),r.push(a),n.Next()}return o}_build_edge_mesh(e){const o=this._occ,r=[],t=new o.TopTools_IndexedMapOfShape_1;o.TopExp.MapShapes_1(e,o.TopAbs_ShapeEnum.TopAbs_EDGE,t);const n=new o.TopTools_IndexedDataMapOfShapeListOfShape_1;o.TopExp.MapShapesAndAncestors(e,o.TopAbs_ShapeEnum.TopAbs_EDGE,o.TopAbs_ShapeEnum.TopAbs_FACE,n);for(let e=1;e<=n.Extent();e++){if(0===n.FindFromIndex(e).Extent())continue;const s=o.TopoDS.Edge_1(t.FindKey(e));let a=new o.gp_Trsf_1;const i=new o.TopLoc_Location_1,p=o.BRep_Tool.Polygon3D(s,i),_={vertexCoord:[],numberOfCoords:0};let c;if(p.IsNull()){const r=o.TopoDS.Face_1(n.FindFromIndex(e).First_1()),t=o.BRep_Tool.Triangulation(r,i,0);i.IsIdentity()||(a=i.Transformation());const p=o.BRep_Tool.PolygonOnTriangulation_1(s,t,i);if(p.IsNull())continue;c=p.get().NbNodes(),_.numberOfCoords=c,_.vertexCoord=new Array(3*c);const d=p.get().Nodes(),l=t.get();for(let e=d.Lower();e<=d.Upper();e++){const o=l.Node(d.Value(e));o.Transform(a);const r=e-1;_.vertexCoord[3*r+0]=o.X(),_.vertexCoord[3*r+1]=o.Y(),_.vertexCoord[3*r+2]=o.Z()}}else{i.IsIdentity()||(a=i.Transformation()),c=p.get().NbNodes(),_.numberOfCoords=c,_.vertexCoord=new Array(3*c);const e=p.get().Nodes();for(let o=0;o<c;o++){const r=e.Value(o+1);r.Transform(a),_.vertexCoord[3*o+0]=r.X(),_.vertexCoord[3*o+1]=r.Y(),_.vertexCoord[3*o+2]=r.Z()}}r.push(_)}return r}}var a,i=r(7930),p=new Uint8Array(16);function _(){if(!a&&!(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(p)}const c=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;for(var d=[],l=0;l<256;++l)d.push((l+256).toString(16).substr(1));const u=function(e){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=(d[e[o+0]]+d[e[o+1]]+d[e[o+2]]+d[e[o+3]]+"-"+d[e[o+4]]+d[e[o+5]]+"-"+d[e[o+6]]+d[e[o+7]]+"-"+d[e[o+8]]+d[e[o+9]]+"-"+d[e[o+10]]+d[e[o+11]]+d[e[o+12]]+d[e[o+13]]+d[e[o+14]]+d[e[o+15]]).toLowerCase();if(!function(e){return"string"==typeof e&&c.test(e)}(r))throw TypeError("Stringified UUID is invalid");return r},h=function(e,o,r){var t=(e=e||{}).random||(e.rng||_)();if(t[6]=15&t[6]|64,t[8]=63&t[8]|128,o){r=r||0;for(var n=0;n<16;++n)o[r+n]=t[n];return o}return u(t)},T="jupytercadOccWorker";class f{constructor(e){this._ready=new i.PromiseDelegate,this._handlers=new Map,this._messageChannels=new Map,this._nativeWorker=e.worker}get ready(){return this._ready.promise}initChannel(){const e=new MessageChannel;e.port1.onmessage=this._processMessage.bind(this);const o=h();this._messageChannels.set(o,e);const r={id:o,action:t.REGISTER,payload:{id:o}};return this._nativeWorker.postMessage(r,[e.port2]),o}removeChannel(e){this._handlers.delete(e),this._messageChannels.delete(e)}registerHandler(e,o,r){this._handlers.has(e)?console.error(`${e} is already registered, remove the handler first before re-registering `):(r&&o.bind(r),this._handlers.set(e,o))}postMessage(e){this._nativeWorker.postMessage(e)}_processMessage(e){e.data.action===n.INITIALIZED&&this._ready.resolve(),this._handlers.forEach((o=>o(e.data)))}}}}]);